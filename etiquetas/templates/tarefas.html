{% from "macros/tarefas/subtarefas_lista_container_macro.html" import subtarefas_lista_container %}{% extends "base.html" %} {% block title %}Tarefas{% endblock %} {% block head
  %}
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"> -->
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css"> -->
  <link
    rel="stylesheet"
    href="{{ url_for('static', filename='css/pages/tarefas.css') }}"
  />
  <style>
    .zoom {
      transform: scale(1.1);
      transition: transform 0.2s;
    }
  </style>
  <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
  <link
    rel="icon"
    href="{{ url_for('static', filename='/svg/tarefas.svg')}}"
  />
  {% endblock %} {% block content %}
  <div id="observacaoModal" class="custom-modal" style="z-index: 9999;">
    <div class="custom-modal-content">
        <h2 class="custom-modal-title">Observações</h2>
        <textarea class="custom-textarea" placeholder="Adicione uma nova observação..."></textarea>
        <div class="custom-modal-footer">
            <button id="cancelarBtn" class="custom-botao custom-cancelar" onclick="toggleModal('observacaoModal')">Cancelar</button>
            <button id="adicionarBtn" class="custom-botao custom-adicionar">Adicionar</button>
        </div>
    </div>
  </div>
  <div id="estimativaModal" class="custom-modal" style="z-index: 9999;">
    <div class="custom-modal-content">
        <h2 class="custom-modal-title">Estimativa para a conclusão</h2>
        <div class="custom-modal-body">
            <!-- <label class="task-title" for="dias">Dias:</label>
            <input type="number" id="dias" min="0" value="0"> -->
            <label for="horas">Horas:</label>
            <input class="task-title" type="number" id="horas-subtask" min="0" value="0">
            <label for="minutos">Minutos:</label>
            <input class="task-title" type="number" id="minutos-subtask" min="0" value="0">
        </div>
        <div class="custom-modal-footer">
            <button id="cancelarBtn" class="custom-botao custom-cancelar" onclick="toggleModal('estimativaModal')">Cancelar</button>
            <button id="adicionarBtn" class="custom-botao custom-adicionar" onclick="updateSubTaskEstimation()">Adicionar</button>
        </div>
    </div>
  </div>
  <div
    id="confirm-remove-file-modal"
    class="custom-modal"
    style="display: none; z-index: 999999"
  >
    <div class="custom-modal-content">
      <div class="custom-modal-header">
        <h2>Confirmar Remoção</h2>
      </div>
      <p>Tem certeza de que deseja remover este arquivo?</p>
      <div class="custom-modal-footer">
        <button
          onclick="toggleModal('confirm-remove-file-modal')"
          class="custom-modal-btn cancel-btn"
        >
          Cancelar
        </button>
        <button id="confirm-remove-btn" class="custom-modal-btn">Remover</button>
      </div>
    </div>
  </div>
  <div
    id="confirm-remove-file-sub-modal"
    class="custom-modal"
    style="display: none; z-index: 999999"
  >
    <div class="custom-modal-content">
      <div class="custom-modal-header">
        <h2>Confirmar Remoção</h2>
      </div>
      <p>Tem certeza de que deseja remover este arquivo?</p>
      <div class="custom-modal-footer">
        <button
          onclick="toggleModal('confirm-remove-file-sub-modal')"
          class="custom-modal-btn cancel-btn"
        >
          Cancelar
        </button>
        <button id="confirm-remove-sub-btn" class="custom-modal-btn">
          Remover
        </button>
      </div>
    </div>
  </div>
  
  <div id="task-files-modal" class="custom-modal">
    <div class="custom-modal-content">
      <div class="custom-modal-header">
        <h1>Arquivos da Tarefa</h1>
      </div>
      <ul id="task-files-list">
        <!-- Os arquivos serão listados aqui dinamicamente -->
      </ul>
      <button
        id="add-file-btn"
        class="custom-modal-btn"
        onclick="toggleModal('task-files-modal')"
      >
        Adicionar Arquivo
      </button>
      <button
        id="remove-file-btn"
        class="custom-modal-btn"
        disabled
        onclick="toggleModal('task-files-modal')"
      >
        Remover Arquivo
      </button>
      <div class="custom-modal-footer">
        <button id="download-btn" class="custom-modal-btn" disabled>
          Download
        </button>
        <button
          class="custom-modal-btn cancel-btn"
          onclick="toggleModal('task-files-modal')"
        >
          Fechar
        </button>
      </div>
    </div>
  </div>
  
  <div
    id="removerSubLinhaModal"
    class="custom-modal"
    style="display: none; z-index: 99999999"
  >
    <div class="custom-modal-content" style="padding: 20px; max-height: 200px">
      <div class="custom-modal-header">
        <h2 class="custom-modal-title">Confirmar exclusão</h2>
      </div>
      <p>Tem certeza de que deseja excluir o(s) registro(s) selecionado(s)?</p>
      <div class="custom-modal-footer">
        <button
          class="custom-modal-btn cancel-btn"
          onclick="toggleModal('removerSubLinhaModal')"
        >
          Cancelar
        </button>
        <button id="removerSubLinhaBtn" class="custom-modal-btn ok-btn">
          Sim
        </button>
      </div>
    </div>
  </div>
  
  <div
    id="subtask-files-modal"
    class="custom-modal"
    style="display: none; z-index: 99999"
  >
    <div class="custom-modal-content">
      <div class="custom-modal-header">
        <h1>Arquivos da Tarefa</h1>
      </div>
      <ul id="subtask-files-list">
        <!-- Os arquivos serão listados aqui dinamicamente -->
      </ul>
      <button
        id="add-file-sub-btn"
        class="custom-modal-btn"
        onclick="toggleModal('subtask-files-modal')"
      >
        Adicionar Arquivo
      </button>
      <button
        id="remove-file-sub-btn"
        class="custom-modal-btn"
        disabled
        onclick="toggleModal('subtask-files-modal')"
      >
        Remover Arquivo
      </button>
      <div class="custom-modal-footer">
        <button id="download-sub-btn" class="custom-modal-btn" disabled>
          Download
        </button>
        <button
          class="custom-modal-btn cancel-btn"
          onclick="toggleModal('subtask-files-modal')"
        >
          Fechar
        </button>
      </div>
    </div>
  </div>
  
  <div
    id="sucess-upload-modal"
    class="custom-modal"
    style="display: none; z-index: 99999"
  >
    <div class="custom-modal-content">
      <div class="custom-modal-header">
        <h2>Sucesso</h2>
      </div>
      <p>Arquivo enviado com sucesso</p>
      <div class="custom-modal-footer">
        <button
          class="custom-modal-btn ok-btn"
          onclick="toggleModal('sucess-upload-modal')"
        >
          OK
        </button>
      </div>
    </div>
  </div>
  
  <div
    id="fail-upload-modal"
    class="custom-modal"
    style="display: none; z-index: 99999"
  >
    <div class="custom-modal-content">
      <div class="custom-modal-header">
        <h2>Erro</h2>
      </div>
      <p>Erro ao enviar arquivo</p>
      <div class="custom-modal-footer">
        <button
          class="custom-modal-btn ok-btn"
          onclick="toggleModal('fail-upload-modal')"
        >
          OK
        </button>
      </div>
    </div>
  </div>
  
  <div id="create-file-modal" class="custom-modal">
    <div class="custom-modal-content">
      <div class="custom-modal-header"></div>
      <form
        id="file-upload-form"
        action="/ferramentas/create-file/task-file"
        method="post"
        enctype="multipart/form-data"
      >
        <input type="text" name="path" value="{{path}}" style="display: none" />
        <input
          type="file"
          name="file"
          accept=".pdf, .txt, .doc, .docx, .rtf, .xlsx, .png, .jpg, .jpeg, .gif, .webp"
          required
        />
        <input type="hidden" name="task_id" id="task-id-field" />
        <br />
        <div class="custom-modal-footer">
          <button
            type="button"
            class="custom-modal-btn cancel-btn"
            onclick="toggleModal('create-file-modal')"
          >
            Cancelar
          </button>
          <button type="submit" class="custom-modal-btn ok-btn">Enviar</button>
        </div>
      </form>
    </div>
  </div>
  
  <div
    id="create-file-sub-modal"
    class="custom-modal"
    style="display: none; z-index: 9999"
  >
    <div class="custom-modal-content">
      <div class="custom-modal-header"></div>
      <form
        id="file-upload-sub-form"
        action="/ferramentas/subtarefa/create-file/task-file"
        method="post"
        enctype="multipart/form-data"
      >
        <input type="text" name="path" value="{{path}}" style="display: none" />
        <input
          type="file"
          name="file"
          accept=".pdf, .txt, .doc, .docx, .rtf, .xlsx, .png, .jpg, .jpeg, .gif, .webp"
          required
        />
        <input type="hidden" name="task_id" id="task-id-field-subtask" />
        <input type="hidden" name="sub_task_id" id="subtask-id-field" />
        <br />
        <div class="custom-modal-footer">
          <button
            type="button"
            class="custom-modal-btn cancel-btn"
            onclick="toggleModal('create-file-sub-modal')"
          >
            Cancelar
          </button>
          <button type="submit" class="custom-modal-btn ok-btn">Enviar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="create-task-modal" class="custom-modal">
    <div class="custom-modal-content modal-size-25p">
      <div class="custom-modal-header">
        <h3>Criar Tarefa</h3>
      </div>
      <div class="full-width">
        <div class="custom-modal-body">
          
          <span>Tempo estimado</span>
          <label for="horas-task-create">Horas:</label>
          <input class="task-title" type="number" id="horas-task-create" min="0" value="0">
          <label for="minutos-task-create">Minutos:</label>
          <input class="task-title" type="number" id="minutos-task-create" min="0" value="0">
          <!--<label for="task-due-date">Data Estimada de Término:</label>
           <input
            type="datetime-local"
            id="task-due-date"
            name="due_date"
            required
          /> -->
        </div>
        <div class="custom-modal-footer">
          <button
            type="button"
            class="custom-modal-btn cancel-btn"
            onclick="toggleModal('create-task-modal')"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="custom-modal-btn ok-btn"
            onclick="postEditTask()"
          >
            Adicionar
          </button>
        </div>
      </div>
    </div>
  </div>

<div id="etiquetasModal" class="custom-modal" style="z-index: 9999;">
  <div class="custom-modal-content">
    <input type="hidden" name="tarefaId">
    <input type="hidden" name="subtarefaId">
    <div class="custom-modal-header">
      <h2 class="custom-modal-title">Etiquetas</h2>
    </div>
    <div class="custom-modal-body">
      <div class="etiquetas-list">
        <form id="etiquetasForm">
          <label for="etiquetasSelect">Selecione as etiquetas:</label>
          <!-- Etiquetas serão carregadas dinamicamente -->
        </form>
      </div>
    </div>
    <div class="custom-modal-footer">
      <button type="button" class="custom-modal-btn cancel-btn" onclick="toggleModal('etiquetasModal')">Cancelar</button>
      <button type="button" class="custom-modal-btn ok-btn" id="adicionarEtiquetasBtn">Adicionar</button>
    </div>
  </div>
</div>
  
  <div id="edit-task-modal" class="custom-modal">
    <div class="custom-modal-content modal-size-25p">
      <div class="custom-modal-header">
        <h3>Editar Tarefa</h3>
      </div>
      <div class="full-width">
        <div class="custom-modal-body">
          <input type="hidden" id="task-id" name="task_id" value="" />
          <label for="task-title">Título:</label>
          <input type="text" id="task-title" name="title" required />
  
          <label for="task-description">Descrição:</label>
          <textarea id="task-description" name="description" required></textarea>
  
          <span>Tempo estimado</span>
          <label for="horas-task-edit">Horas:</label>
          <input class="task-title" type="number" id="horas-task-edit" min="0" value="0">
          <label for="minutos-task-edit">Minutos:</label>
          <input class="task-title" type="number" id="minutos-task-edit" min="0" value="0">
          <!-- <label for="task-due-date">Data Estimada de Término:</label>
          <input
            type="datetime-local"
            id="task-due-date"
            name="due_date"
            required
          /> -->
        </div>
        <div class="custom-modal-footer">
          <button
            type="button"
            class="custom-modal-btn cancel-btn"
            onclick="toggleModal('edit-task-modal')"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="custom-modal-btn ok-btn"
            onclick="postEditTask()"
          >
            Adicionar
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="observacoesModal" class="custom-modal" style="z-index: 9999;">
    <div class="custom-modal-content modal-size-25p">
      <div class="custom-modal-header">
        <h2 class="custom-modal-title">Observações</h2>
      </div>
      <div id="observacoesList" class="observacoes-list">
        <!-- As observações existentes serão listadas aqui -->
      </div>
      <textarea style="resize: none" id="novaObservacao" class="nova-observacao-input"
        placeholder="Adicione uma nova observação..."></textarea>
      <div class="custom-modal-footer">
        <button class="custom-modal-btn cancel-btn" onclick="toggleModal('observacoesModal')">
          Cancelar
        </button>
        <button id="observacaoAdd" class="custom-modal-btn ok-btn">
          Adicionar
        </button>
      </div>
    </div>
  </div>
  
  <div id="subtarefasModal" class="custom-modal" tarefaId="">
    <div class="custom-modal-content">
      <!-- <div class="custom-modal-content modal-size-25p"> -->
      <div class="custom-modal-header">
        <h2 class="custom-modal-title">Subtarefas</h2>
        <button 
          type="button" 
          class="custom-modal-btn ok-btn" 
          id="abrirColunaSubtarefaModalButton"
          onclick="abrirOpcoesModal()"
        >
            +
        </button>
      </div>
      <div class="custom-modal-body">
        <div class="subtarefasListasContainer">
          {{ subtarefas_lista_container("Pendentes", "pendente", "f1c40f", True, True) }}
          {{ subtarefas_lista_container("Em Andamento", "em andamento", "e67e22", True, False) }}
          {{ subtarefas_lista_container("Concluído", "concluido", "27ae60", True, False) }}
          {% if current_user.is_admin() %}
            {{ subtarefas_lista_container("Lixeira", "lixeira", "ae3027", True, False) }}
          {% endif %}
        </div>
      </div>
      <div class="custom-modal-footer">
        <button class="custom-modal-btn cancel-btn" onclick="fecharModalSubtarefas()">
          Fechar
        </button>
        <!-- <button id="observacaoAdd" class="custom-modal-btn ok-btn">
            Adicionar
          </button> -->
        <!--<button id="lixeiraBtn" class="lixeira-btn" onclick="abrirLixeiraModal()">
          Lixeira
        </button>-->
      </div>
    </div>
  </div>
  <!-- Modal para Registros -->
  <div id="registrosModal" class="custom-modal">
    <div class="custom-modal-content custom-modal-size-50p">
      <div class="custom-modal-header">
        <h2 class="custom-modal-title">Registros de Alterações</h2>
      </div>
      <div id="registrosList" class="registros-list">
        <!-- Os registros serão inseridos aqui dinamicamente -->
      </div>
      <div class="custom-modal-footer">
        <button class="custom-modal-btn cancel-btn" onclick="toggleModal('registrosModal')">
          Fechar
        </button>
      </div>
    </div>
  </div>
  
  <div id="colaboradores-ativo-subtarefa-modal" class="custom-modal-subtarefa" style="display: none">
    <div class="custom-modal-content left-align">
      <div class="custom-modal-header">
        <h2>Colaboradores ativos subtarefa</h2>
      </div>
      <div class="colaboradores-container-subtarefas colaboradores-ativos-subtarefas" style="
            overflow: auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            padding-left: 3px;
            max-height: 500px;
            margin-bottom: 20px;
          ">
        <p></p>
      </div>
      <div class="custom-modal-separator"></div>
      <p>Adicionar colaborador</p>
      <div class="custom-checkbox-container">
        <label for="select-all-checkbox-subtarefa" class="custom-checkbox-label-name">Selecionar Todos</label>
        <input type="checkbox" name="select-all-checkbox" id="select-all-checkbox-subtarefa" class="custom-checkbox"
          onchange="selectAllCheckboxSubtarefas(this)" />
        <label for="select-all-checkbox-subtarefa" class="custom-checkbox-label"></label>
      </div>
      <div class="colaboradores-container-subtarefas colaboradores-inativos-subtarefas" style="
            overflow: auto;
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            padding-left: 25px;
            max-height: 500px;
            margin-bottom: 20px;
          "></div>
      <div class="custom-modal-footer">
        <button class="custom-modal-btn cancel-btn" onclick="toggleModal('colaboradores-ativo-subtarefa-modal')">
          Fechar
        </button>
        <button class="custom-modal-btn ok-btn" id="colaboradores-ativo-subtarefa-modal-ok">
          Salvar
        </button>
      </div>
    </div>
  </div>
  
  <div id="detalhes-subtarefa-modal" class="custom-modal-detalhes" style="display: none">
    <div class="custom-modal-content left-align">
      <div class="custom-modal-header">
        <h2>Sub Tarefa</h2>
      </div>
      <div class="custom-modal-body">
        <input type="hidden" id="task-id" name="task_id" value="" />
  
        <label for="">Criado em:</label>
        <span id="task-criado-em" name="created_at"></span>
  
        <label for="">Criado Por:</label>
        <span id="task-criado-por" name="criado_por"></span>
  
        <label for="">Descrição:</label>
        <span id="task-descricao" name="description"></span>
      </div>
      <div class="custom-modal-footer">
        <button class="custom-modal-btn cancel-btn" onclick="toggleModal('detalhes-subtarefa-modal')">
          Fechar
        </button>
      </div>
    </div>
  </div>
  
  <div id="colaborador-ativo-modal" class="custom-modal">
    <div class="custom-modal-content left-align">
      <div class="custom-modal-header">
        <h2>Colaborador ativo</h2>
      </div>
      <div class="colaboradores-container colaboradores-ativos">
        <p>
          <!-- aqui no futuro vai receber dados do backend, assim agora apenas para testar. -->
        </p>
      </div>
      <div class="modal-separator"></div>
      <p>Adicionar colaborador</p>
      <div class="custom-checkbox-container">
        <label for="select-all-checkbox-colaborador-ativo" class="custom-checkbox-label-name">Selecionar Todos</label>
        <input type="checkbox" name="select-all-checkbox" id="select-all-checkbox-colaborador-ativo"
          class="custom-checkbox" onchange="selectAllCheckboxColaboradoresAtivos(this)" />
        <label for="select-all-checkbox-colaborador-ativo" class="custom-checkbox-label"></label>
      </div>
      <div class="colaboradores-container colaboradores-inativos">
        <!-- aqui no futuro vai receber dados do backend, assim agora apenas para testar. -->
      </div>
      <div class="custom-modal-footer">
        <button class="custom-modal-btn cancel-btn" onclick="toggleModal('colaborador-ativo-modal')">
          Cancelar
        </button>
        <button class="custom-modal-btn ok-btn" id="btnAtualizarColaboradores">
          Atualizar
        </button>
      </div>
    </div>
  </div>
  
  <div class="tarefas-toolbar">
    <div class="year-selector centered-item">
      <button class="button-month" onclick="changeMonth(-1)">&#x3C;</button>
      <span id="year-name" onclick="window.location.href = window.location.pathname">{{meses[mes-1][0]}} de
        {{anoVerificado}}</span>
      <button class="button-month" onclick="changeMonth(1)">&#x3E;</button>
    </div>
    <div class="filter-icon-container right-item">
      <div style="gap: 10px; display: flex; margin-right: 10px">
        <button onclick="abrirModalFiltrar()" class="filter-button" title="Filtrar">
          <img src="{{ url_for('static', filename='/svg/filter-svgrepo-com.svg') }}" alt="Filtrar" />
        </button>
      </div>
    </div>
  </div>
  <div class="date-selector">
    <button class="button-date" onclick="window.location.href = '/ferramentas/tarefas' + '?data=hoje'">
      Hoje
    </button>
    <button class="button-date" onclick="window.location.href = '/ferramentas/tarefas' + '?data=ontem'">
      Ontem
    </button>
    <button class="button-date" onclick="window.location.href = window.location.pathname + '?data=outras'">
      Outras datas
    </button>
  </div>
  
  <div class="container-fluid" style="display: flex; justify-content: center">
    <div class="container-progress">
      <div class="status-container" id="status-criado">
        <div class="circle" style="background-color: #3498db">
          <i class="fas fa-tasks icon"></i>
          <div class="count">
            {% if tarefas_status['total'] > 0 %} {{ tarefas_status['criado'] }} -
            {{ (tarefas_status['criado'] / tarefas_status['total'] * 100)|int }}%
            {% else %} - {% endif %}
          </div>
          <!-- Círculo de progresso -->
          <div class="progress-circle"></div>
        </div>
        <div class="status-title" style="color: #3498db">Criado</div>
      </div>
      <div class="status-container" id="status-em-andamento">
        <div class="circle" style="background-color: #f39c12">
          <i class="fas fa-play icon"></i>
          <div class="count">
            {% if tarefas_status['total'] > 0 %} {{ tarefas_status['em-andamento']
            }} - {{ (tarefas_status['em-andamento'] / tarefas_status['total'] *
            100)|int }}% {% else %} - {% endif %}
          </div>
          <!-- Círculo de progresso -->
          <div class="progress-circle"></div>
        </div>
        <div class="status-title" style="color: #f39c12">Andamento</div>
      </div>
      <div class="status-container" id="status-parado">
        <div class="circle" style="background-color: #e74c3c">
          <i class="fas fa-pause icon"></i>
          <div class="count">
            {% if tarefas_status['total'] > 0 %} {{ tarefas_status['parado'] }} -
            {{ (tarefas_status['parado'] / tarefas_status['total'] * 100)|int }}%
            {% else %} - {% endif %}
          </div>
          <!-- Círculo de progresso -->
          <div class="progress-circle"></div>
        </div>
        <div class="status-title" style="color: #e74c3c">Parado</div>
      </div>
      <div class="status-container" id="status-concluido">
        <div class="circle" style="background-color: #2ecc71">
          <i class="fas fa-check-circle icon"></i>
          <div class="count">
            {% if tarefas_status['total'] > 0 %} {{ tarefas_status['concluido'] }}
            - {{ (tarefas_status['concluido'] / tarefas_status['total'] * 100)|int
            }}% {% else %} - {% endif %}
          </div>
          <!-- Círculo de progresso -->
          <div class="progress-circle"></div>
        </div>
        <div class="status-title" style="color: #2ecc71">Concluído</div>
      </div>
    </div>
  </div>
  <div class="container-fluid py-4">
    <div class="row">
      <!-- Next Steps Column -->
      <div class="col-lg-12 mb-12">
        <!-- Card for Next Steps -->
        <div class="container-fluid">
          {% set meses = [ ('Janeiro', 'jan'), ('Fevereiro', 'fev'), ('Março',
          'mar'), ('Abril', 'abr'), ('Maio', 'mai'), ('Junho', 'jun'), ('Julho',
          'jul'), ('Agosto', 'ago'), ('Setembro', 'set'), ('Outubro', 'out'),
          ('Novembro', 'nov'), ('Dezembro', 'dez') ] %} {#{% for month, abrev in
          meses %}#} {% set month, abrev = meses[mes-1] %} {% for day, tarefas in
          tarefas_por_dia.items() %}
          <div class="monthTable">
            <div class="title-1 title-{{ day }}">
              {% if day == 0 %} Sem data {% else %} {{day}} de {{month}} {% endif %}
  
            </div>
            <table class="table table-hover table-{{ day }} leadsTable" id="leadsTable{{ day }}" style="margin-bottom: 0">
              <thead>
                <tr>
                  <th scope="col" class="title-2 checkbox-column">Sel.</th>
                  <th scope="col" class="title-2 inicio-column">Início</th>
                  <th scope="col" class="title-2">Tarefa</th>
                  <th scope="col" class="title-2 resp-column">Resp.</th>
                  <th scope="col" class="title-2 col-observacao">Obs.</th>
                  <th scope="col" class="title-2 col-registro" style="width: 4%">
                    Registro
                  </th>
                  <th scope="col" class="title-2 col-subtarefas">Subtarefas</th>
                  <th scope="col" class="title-2 col-status">Status</th>
                  <th scope="col" class="title-2 col-arquivo">Arquivos</th>
                  <th scope="col" class="title-2 col-timeline">Prazo Final</th>
                </tr>
              </thead>
              <tbody>
                <tr class="hidden-row">
                  <td class="status-cell">
                    <div class="status">New Lead</div>
                  </td>
                  <td class="status-cell">
                    <div class="status">New Lead</div>
                  </td>
                  <td class="status-cell">
                    <div class="status">New Lead</div>
                  </td>
                  <td class="status-cell">
                    <div class="status">New Lead</div>
                  </td>
                  <td class="status-cell">
                    <div class="status">New Lead</div>
                  </td>
                  <td class="status-cell">
                    <div class="status">New Lead</div>
                  </td>
                  <td class="status-cell">
                    <div class="status">New Lead</div>
                  </td>
                  <td class="status-cell">
                    <div class="status">New Lead</div>
                  </td>
                  <td class="status-cell">
                    <div class="status">New Lead</div>
                  </td>
                  <td class="status-cell">
                    <div class="status">New Lead</div>
                  </td>
                </tr>
                {% for tarefa in tarefas %}
                <tr id="{{ tarefa.id }}" data-descricao="{{ tarefa.descricao|default('Descrição da tarefa') }}">
                  <td data-column-name="selected">
                    <input type="checkbox" class="task-checkbox custom-checkbox" id="task-{{ tarefa.id }}" />
                    <label for="task-{{ tarefa.id }}" class="task-checkbox-label custom-checkbox-label"></label>
                  </td>
                  <td data-column-name="inicio" class="" contenteditable="false">
                    {{ tarefa.criado_em }}
                  </td>
                  <td data-column-name="nome-tarefa" contenteditable="false">
                    {{ tarefa.nome.strip() }}
                  </td>
                  <td data-column-name="responsavel" contenteditable="false">
                    <img
                      src="/static/images/{{ tarefa.responsaveis[0].imagem if tarefa.responsaveis|length > 0 else 'user/avatar-1.jpg' }}"
                      alt="" class="user-photo"
                      onclick="abrirModalColaboradores('{{ tarefa.id }}')" /><!-- tarefa.usuario_criador_imagem if tarefa.usuario_criador_imagem else 'user/avatar-1.jpg' //tarefa.responsaveis[0].imagem if tarefa.responsaveis|length > 0 else 'user/avatar-1.jpg'  -->
                    <span class="tooltiptext"> {{tarefa.responsaveis.nome}}</span>
                  </td>
                  <td data-column-name="observacoes" class="svg-image"
                    onclick="mostrarObservacoesModal('{{ tarefa.id }}')">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                      <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                      <g id="SVGRepo_iconCarrier">
                        {% if tarefa.observacoes %}
                        <path
                          d="M15.3 19.1C14.1219 19.6951 12.8199 20.0035 11.5 20C9.92179 19.9994 8.37488 19.5594 7.03258 18.7293C5.69028 17.8992 4.6056 16.7118 3.90003 15.3C3.30496 14.1219 2.99659 12.8199 3.00003 11.5V11C3.11502 8.91568 3.99479 6.94699 5.47089 5.47089C6.94699 3.99479 8.91568 3.11502 11 3.00003M15.3 3.90003C16.7118 4.6056 17.8992 5.69028 18.7293 7.03258C19.5594 8.37488 19.9994 9.92179 20 11.5C20.0035 12.8199 19.6951 14.1219 19.1 15.3L21 21L18 20M8 9.5H15M8 13.5H13"
                          stroke="#36d9ce" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                        {% else %}
                        <path
                          d="M15.3 19.1C14.1219 19.6951 12.8199 20.0035 11.5 20C9.92179 19.9994 8.37488 19.5594 7.03258 18.7293C5.69028 17.8992 4.6056 16.7118 3.90003 15.3C3.30496 14.1219 2.99659 12.8199 3.00003 11.5V11C3.11502 8.91568 3.99479 6.94699 5.47089 5.47089C6.94699 3.99479 8.91568 3.11502 11 3.00003M15.3 3.90003C16.7118 4.6056 17.8992 5.69028 18.7293 7.03258C19.5594 8.37488 19.9994 9.92179 20 11.5C20.0035 12.8199 19.6951 14.1219 19.1 15.3L21 21L18 20M8 9.5H15M8 13.5H13"
                          stroke="#878787" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                        {% endif %}
                      </g>
                    </svg>
                  </td>
                  <td contenteditable="false" class="svg-image" onclick="mostrarRegistros('{{ tarefa.id }}')">
                    <img src="/static/svg/register-svgrepo-com.svg" class="round-img" />
                  </td>
                  <td data-column-name="subtarefas" contenteditable="false"
                    onclick="mostrarSubtarefasModal('{{ tarefa.id }}')">
                    {% if tarefa.subtarefas|length > 0 %}
                    <i class="bi bi-stack linhaPossuiSubtarefas"></i>
                    {% else %}
                    <i class="bi bi-stack"></i>
                    {% endif %}
                  </td>
                  {% if tarefa.status == 'Criado' %}
                  <td data-column-name="status" class="status-cell" contenteditable="false">
                    {{ tarefa.status }}
                  </td>
                  {% else %}
                  <td data-column-name="status" class="status-cell {{ tarefa.status|replace(' ', '-')|lower }}"
                    contenteditable="false">
                    {{ tarefa.status }}
                  </td>
                  {% endif %}
  
                  <td data-column-name="arquivos" contenteditable="false" data-task-id="{{ tarefa.id }}"
                    onclick="openTaskFilesModal('{{ tarefa.id }}')">
                    {% if not tarefa.arquivos %}
                    <i class="bi bi-file-earmark"></i>
  
                    {% else %}
                    <i class="bi bi-file-earmark-check"></i>
                    {% endif %}
                  </td>
                  <td data-column-name="prazo-estimado" contenteditable="false">
                    <div>
                      {% if tarefa.horas_estimadas != None and tarefa.minutos_estimados != None %}
                      <div class="progress-container" data-horas="{{ tarefa.horas_estimadas or 0 }}" data-minutos="{{ tarefa.minutos_estimados or 0 }}">
                        <div class="progress-bar progress-green" id="progressBar-{{ tarefa.id }}">0%</div>
                      </div>
                      <div class="progress-label" id="progressText-{{ tarefa.id }}"></div>
                      {% else %}
                      <p>Estimativa não definida</p>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
                <!-- Add more rows as needed -->
              </tbody>
            </table>
            <!-- <div class="toolbar table-{{day}}">
              <button class="createLeadBtn" data-day="{{day}}" data-month="{{abrev}}">
                + Adicionar Tarefa
              </button>
              <! -- Outros botões e elementos da barra de ferramentas aqui -- >
            </div> -->
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <div id="filtrarModal" class="custom-modal" style="display: none">
    <form id="filtroForm">
      <div class="custom-modal-content custom-modal-content-small">
        <div class="custom-modal-header">
          <h2 class="custom-modal-title">Filtrar Linhas</h2>
        </div>
        <div class="custom-modal-body">
          <div>
            <label for="excluidos">Excluídos:</label>
            <select id="excluidos" name="excluidos">
              <!-- <option value="" selected></option> -->
              <option value="false" selected>Não</option>
              <option value="true">Sim</option>
            </select>
          </div>
          <div>
            <label for="responsavel">Responsável:</label>
            <select id="responsavel" name="responsavel">
              <option value="" selected></option>
            </select>
          </div>
          <div>
            <label for="status">Status:</label>
            <select id="status" name="status">
              <option value="" selected></option>
            </select>
          </div>
          <div>
            <label for="data_search">Data:</label>
            <input type="date" name="data_search" id="data_search" />
          </div>
        </div>
        <div class="custom-modal-footer">
          <button
            type="button"
            class="custom-modal-btn cancel-btn"
            onclick="toggleModal('filtrarModal')"
          >
            Cancelar
          </button>
          <button
            type="button"
            class="custom-modal-btn cancel-btn"
            onclick="document.getElementById('filtroForm').reset()"
          >
            Limpar filtros
          </button>
          <button type="submit" class="custom-modal-btn ok-btn">Pesquisar</button>
        </div>
      </div>
    </form>
  </div>
  <div class="main-toolbar">
    <div class="main-toolbar-icon-lixeira">
      <div class="main-toolbar-icon" id="editar-coluna">
        <img
          src="{{ url_for('static', filename='/svg/editIconWhite.svg') }}"
          alt=""
          style="height: 20px; width: 20px"
        />
        <span class="icon-label">Editar Coluna</span>
      </div>
      <div class="main-toolbar-icon" id="excluir-coluna">
        <img
          src="{{ url_for('static', filename='/svg/trashIconWhite.svg') }}"
          alt=""
          style="height: 20px; width: 20px"
        />
        <span class="icon-label">Excluir Coluna</span>
      </div>
      <div style="margin-right: 10px;" id="editar-icon">
        <img
          src="{{ url_for('static', filename='/svg/editIconWhite.svg') }}"
          alt=""
          id="edit-icon"
          style="height: 18px; width: 18px"
        />
        <span class="icon-label">Editar</span>
      </div>
      <div class="main-toolbar-icon" id="lixeira-icon">
        <img
          src="{{ url_for('static', filename='/svg/trashIconWhite.svg') }}"
          alt=""
          style="height: 20px; width: 20px"
        />
        <span class="icon-label">Excluir</span>
      </div>
      <div class="main-toolbar-icon" id="restaurar-icon" onclick="restaurarSubtarefaLixeira()" style="display: none;">
        <i class="bi bi-arrow-counterclockwise"></i>
        <span class="icon-label">Restaurar</span>
      </div>
      <div class="main-toolbar-icon" id="excluir-icon" onclick="abrirDeleteSubtaskModal()" style="display: none;">
        <img
          src="{{ url_for('static', filename='/svg/trashIconWhite.svg') }}"
          alt=""
          style="height: 20px; width: 20px"
        />
        <span class="icon-label">Excluir</span>
      </div>
    </div>
    <!-- <div class="main-toolbar-icon">
      <i class="fas fa-folder icon" style="color: white" id="move-icon"></i>
      <span class="icon-label">Mover</span>
    </div>
    <div class="main-toolbar-icon">
      <i class="fas fa-print icon" style="color: white"></i>
      <span class="icon-label">Imprimir</span>
    </div>
    <div class="main-toolbar-icon">
      <img
        src="{{ url_for('static', filename='/svg/shareWhite.svg') }}"
        alt=""
        onclick=""
        style="height: 25px; width: 25px"
      />
      <span class="icon-label">Compartilhar</span>
    </div> -->
    {% if lixeira %}
    <div class="main-toolbar-icon" onclick="toggleModal('restaurarLinhaModal')">
      <img
        src="{{ url_for('static', filename='/svg/restoreWhite.svg') }}"
        alt=""
        style="height: 20px; width: 20px"
      />
      <span class="icon-label">Restaurar</span>
    </div>
    {% endif %}
    <div class="main-toolbar-icon" id="delete-icon">
      <img
        src="{{ url_for('static', filename='/svg/trashIconWhite.svg') }}"
        alt=""
        style="height: 20px; width: 20px"
      />
      {% if lixeira %}
      <span class="icon-label">Excluir</span>
      {% else %}
      <span class="icon-label">Lixeira</span>
      {% endif %}
    </div>
  </div>
  
  <div id="removerLinhaModal" class="custom-modal" style="display: none">
    <div class="custom-modal-content" style="padding: 20px; max-height: 200px">
      <div class="custom-modal-header">
        <h2 class="custom-modal-title">Confirmar exclusão</h2>
      </div>
      <p>Tem certeza de que deseja excluir o(s) registro(s) selecionado(s)?</p>
      <div class="custom-modal-footer">
        <button
          class="custom-modal-btn cancel-btn"
          onclick="toggleModal('removerLinhaModal')"
        >
          Cancelar
        </button>
        <button id="removerLinhaBtn" class="custom-modal-btn ok-btn">Sim</button>
      </div>
    </div>
  </div>
  
  <div id="restaurarLinhaModal" class="custom-modal" style="display: none">
    <div class="custom-modal-content" style="padding: 20px; max-height: 200px">
      <div class="custom-modal-header">
        <h2 class="custom-modal-title">Confirmar restauração</h2>
      </div>
      <p>Tem certeza de que deseja restaurar a(s) tarefas(s) selecionada(s)?</p>
      <div class="custom-modal-footer">
        <button
          class="custom-modal-btn cancel-btn"
          onclick="toggleModal('restaurarLinhaModal')"
        >
          Cancelar
        </button>
        <button id="restaurarLinhaBtn" class="custom-modal-btn ok-btn">
          Sim
        </button>
      </div>
    </div>
  </div>
  
  <div id="edit-warning-modal" class="custom-modal" style="display: none">
    <div class="custom-modal-content" style="padding: 20px; max-height: 200px">
      <div class="custom-modal-header">
        <h2>Erro</h2>
      </div>
      <p>Apenas uma tarefa pode ser editada por vez.</p>
      <div class="custom-modal-footer">
        <button
          class="custom-modal-btn ok-btn"
          onclick="toggleModal('edit-warning-modal')"
        >
          OK
        </button>
      </div>
    </div>
  </div>
  <div id="opcoesModal" class="custom-modal">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h2 class="custom-modal-title">Escolha uma opção</h2>
        </div>
        <div class="custom-modal-body">
            <button 
                type="button" 
                class="custom-modal-btn ok-btn" 
                onclick="abrirColunaSubtarefaModal()"
            >
                Criar Coluna
            </button>
            <span class="close" onclick="fecharOpcoesModal()"></span>
            <button 
                type="button" 
                class="custom-modal-btn ok-btn" 
                onclick="abrirEtiquetaModal()"
            >
                Criar Etiqueta
            </button>
         </div>
        <div class="custom-modal-footer">
            <button
                type="button"
                class="custom-modal-btn cancel-btn"
                onclick="toggleModal('opcoesModal')"
            >
                Cancelar
            </button>
         </div>
      </div>
   </div>
  <div id="colunaSubtarefaModal" class="custom-modal" style="display: none">
    <form id="colunaSubtarefaForm">
      <div class="custom-modal-content custom-modal-content-small">
        <div class="custom-modal-header">
          <h2 class="custom-modal-title">Criar coluna</h2>
        </div>
        <div class="custom-modal-body">
          <input type="hidden" name="id-tarefa">
          <input type="hidden" name="nome-antigo-coluna">
          <label for="nomeColunaSubtarefaForm">Nome:</label>
          <input id="nomeColunaSubtarefaForm" type="text" name="nome" required>
          <label for="corColunaSubtarefaForm">Cor:</label>
          <input id="corColunaSubtarefaForm" type="color" name="cor">
        </div>
        <div class="custom-modal-footer">
          <button
            type="button"
            class="custom-modal-btn cancel-btn"
            onclick="toggleModal('colunaSubtarefaModal')"
          >
            Cancelar
          </button>
          <button type="submit" class="custom-modal-btn ok-btn">Criar</button>
        </div>
      </div>
    </form>
  </div>
  <div id="etiquetaModal" class="custom-modal">
    <div class="custom-modal-content">
        <div class="custom-modal-header">
            <h2 class="custom-modal-title">Criar Etiqueta</h2>
        </div>
        <div class="custom-modal-body">
            <label for="nomeEtiquetaForm">Nome:</label>
            <input id="nomeEtiquetaForm" type="text" name="nome" required>
            <label for="corEtiquetaForm">Cor:</label>
            <input id="corEtiquetaForm" type="color" name="cor">
        </div>
        <div class="custom-modal-footer">
            <button type="button" class="custom-modal-btn cancel-btn" onclick="toggleModal('etiquetaModal')">Cancelar</button>
            <button type="button" class="custom-modal-btn ok-btn" onclick="criarEtiqueta()">Criar</button>
        </div>
    </div>
  </div>
  <div id="text-modal-tarefa" class="custom-modal" style="display: none">  
    <div class="custom-modal-content">
      <h1 id="titulo-modal"></h1>
      <textarea name="textarea-modal-tarefa-name" id="textarea-modal-tarefa-id" style="font-size: 20px;" rows="20" cols="100"></textarea>
      <button
          class="custom-modal-btn ok-btn"
          onclick="fecharTarefaTextModal()"
        >
          OK
        </button>
    </div>
  </div>
  <div id="text-modal-subtarefa" class="custom-modal" style="display: none">  
    <div class="custom-modal-content">
      <textarea name="textarea-modal-name-subtarefa" id="textarea-modal-subtarefa-id" style="font-size: 20px;" rows="20" cols="100" autofocus></textarea>
      <div class="custom-modal-footer">
        <button
          class="custom-modal-btn cancel-btn"
          onclick="toggleModal('text-modal-subtarefa')"
        >
        Cancelar
        <button
        class="custom-modal-btn ok-btn"
        onclick="fecharSubtarefaTextModal()"
      >
        OK
      </button>
      </div>
        </button>
    </div>
  </div>

  <div id="modal-foco-coluna" class="custom-modal" style="display: none"> 

    <div class="modal-foco-coluna-body">
      <div class="modal-foco-coluna-header">
        <h3 id="modal-foco-coluna-nome" class="modal-foco-coluna-nome">TESTE</h3>
      </div>
      <div class="modal-foco-coluna-container" style="background: red;" nome-status="">

      </div>
    </div>
    <div class="btn-container">
      <button
        class="foco-coluna-btn"
        onclick="fecharModalFocoColuna()"
      >
        X
      </button>
    </div>
  </div>



  <div id="lixeira-modal" class="custom-modal" style="display: none">
    <div class="custom-modal-content"> 
    <h2>Lixeira</h2> <br>
    <div id="lixeira-custom-modal-content" class="lixeira-custom-modal-content">
    </div>
    <div class="custom-modal-footer">
      <button
        class="custom-modal-btn cancel-btn"
        onclick="toggleModal('lixeira-modal')"
      >
      Cancelar</button>
      <button
        class="custom-modal-btn cancel-btn"
        onclick="restaurarSubtarefaLixeira()"
      >
      Restaurar</button>
      <button
      class="custom-modal-btn delete-btn"
      onclick=" abrirDeleteSubtaskModal()"
    >
      Deletar
    </button>
    </div>
  </div>
  </div>

  <div id="delete-item-modal" class="custom-modal">
    <div class="custom-modal-content modal-size-70p">
      <input
        type="hidden"
        id="modal-id-transacao-delete"
        name="idTransacaoDelete"
        value=""
      />
      <div class="custom-modal-body">
        <div class="container">
          <h2 class="delete-confirmation">Confirmação de Exclusão</h2>
          <p>Voce tem certeza que deseja remover esta sub-tarefa??</p>
        </div>
      </div>
      <div class="custom-modal-footer">
        <button
          type="button"
          class="custom-modal-btn cancel-btn"
          onclick="toggleModal('delete-item-modal')"
        >
          Cancelar
        </button>
        <button
          class="custom-modal-btn delete-btn"
          onclick="deleteSelectedSubTasks()"
        >
          Confirmar
        </button>
      </div>
    </div>
  </div>

    
  <div id="newLead-modal" class="custom-modal" style="display: none">
    <div class="custom-modal-content"> 
      <h2>Nova Tarefa</h2> <br>
      <div id="newLead-custom-modal-content" class="newLead-custom-modal-content">
        <label for="createlead-titulo">Titulos:</label>
        <input type="text" id="createlead-titulo" placeholder="Nova Tarefa">
        <label for="createlead-descricao">Descrição:</label>
        <textarea id="createlead-descricao" rows="3" cols="40" placeholder="O que precisa ser feito..."></textarea>
        <span>Tempo estimado</span>
        <label for="horas-task-new-lead">Horas:</label>
        <input class="task-title" type="number" id="horas-task-new-lead" min="0" value="0">
        <label for="minutos-task-new-lead">Minutos:</label>
        <input class="task-title" type="number" id="minutos-task-new-lead" min="0" value="0">
      </div>
      <div class="custom-modal-footer">
        <button
          class="custom-modal-btn cancel-btn"
          onclick="toggleModal('newLead-modal')"
        >
        Cancelar</button>
        <button
          class="custom-modal-btn criar-btn"
          onclick="criandoNovoLead()"
        >
        Criar
        </button>
      </div>
    </div>
  </div>

  <div id="text-modal-newTarefa" class="custom-modal" style="display: none">  
    <div class="custom-modal-content">
      <h1 id="titulo-modal">Descrição</h1>
      <textarea name="textarea-modal-newTarefa-name" id="textarea-modal-newTarefa-id" style="font-size: 20px;" rows="20" cols="100"></textarea>
      <button
          class="custom-modal-btn ok-btn"
          onclick="fecharNewTarefaTextModal()"
        >
          OK
        </button>
    </div>
  </div>
  
  {% block button_action %} 
  {% if 'adm' in user_permissions %}
  <button
      id="createLeadBtn"
      class="createLeadBtn"
      onclick="toggleModal('newLead-modal')"
    >
      + 
    </button>
  {% endif %}
  {% endblock %}

  {% endblock %} {% block scripts %}
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{{url_for('static', filename='js/utils/rgb.js')}}"></script>
  <script>
    let textoSubtarefaAntesDeAlterar = "";
    let subtarefaIdToDrag = null;
    let selectedEtiquetas = [];
    let subtarefaIdToDragElement = null;
    let scrollInterval = null;
    let dataConsultada = new Date();
    // let anoAtualmenteVisivel = dataConsultada.getFullYear().toString();
    let anoAtualmenteVisivel = {{anoVerificado}}
    let mesAtualmenteVisivel = {{mes}}
    let tarefasStatus = {{ tarefas_status|tojson }}
  
    let textareaTarefa = null;
    let textareaSubtarefa = null;
  
    var selectionType = "tarefas";
    var subTaskProgressInterval = {};

    const deleteIcon = document.getElementById('delete-icon');
    const lixeiraIcon = document.getElementById('lixeira-icon');//Pegando o icone da lixeira
    const editarColunaIcon = document.getElementById('editar-coluna');
    editarColunaIcon.style.display = "none";
    const excluirColunaIcon = document.getElementById('excluir-coluna');
    excluirColunaIcon.style.display = "none";
    var subtarefaLixeiraVisivel = false;//variavel para saber se a lixeira está visivel ou nao
    var isAdmin = {{current_user.is_admin()|tojson}};
    var isSuperUser = {{current_user.has_role('super-user')|tojson}};
    
    if(!subtarefaLixeiraVisivel){
          lixeiraIcon.style.display = "none";
          deleteIcon.style.display = "block";
      } else {
          lixeiraIcon.style.display = "block";
          deleteIcon.style.display = "none";
      }

    


    editarColunaIcon.addEventListener("click", function(){
      updateSelectedColumns();
      if(selectedColumns.length > 1 ){
        alert("Selecione uma coluna por vez!");
        return;
      }
      const checkbox = document.querySelector('.coluna-checkbox:checked');
      abrirColunaSubtarefaModal(checkbox);
      checkbox.checked = false;
      handleCheckboxChangeColumn();
    })

    excluirColunaIcon.addEventListener("click", function(){
      updateSelectedColumns();
      if(selectedColumns.length > 1 ){
        alert("Selecione uma coluna por vez!");
        return;
      }
      const checkbox = document.querySelector('.coluna-checkbox:checked');
      checkbox.checked = false;
      handleCheckboxChangeColumn();
      removerColunaSubtarefa(checkbox);
    })


    function scrollDownTarefasPendentes() {
      var element = document.getElementById("subtarefasPendentesLista");
      element.scrollTop = element.scrollHeight;
    }

    function abrirModalFocoColuna(subtarefasContainer){

      const container = subtarefasContainer.closest(".subtarefasListaContainer");
      loadingIndicator.style.display = "flex";

      const modalFoco = document.getElementById('modal-foco-coluna')

      const titulo = container.querySelector('h3.subtarefaListaNome');
      var status = titulo.getAttribute('nome_coluna').toLowerCase();
      status = status == "pendentes"? "pendente":status;
      status = status == "concluído"? "concluido":status;
      const cor = container.querySelector('div.subtarefasLista').getAttribute('style').match(/#(?:[A-Fa-f0-9]{6})/);

      const focoContainer = modalFoco.querySelector('div.modal-foco-coluna-container');

      modalFoco.querySelector('#modal-foco-coluna-nome').textContent = titulo.getAttribute('nome_coluna');
      focoContainer.setAttribute('style', `background-color: ${cor}`);
      focoContainer.setAttribute('nome-status',`${status}`)

      focoContainer.innerHTML = "";

      fetch(`/ferramentas/tarefa/subtarefas/${status}/${currentTaskId}`, {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                  },
      })
        .then((response) => {
          if (!response.ok) {
            return response.json().then((data) => {;
              throw new Error(data.message);
            });
          }
          return response.json();
        })
        .then((data) => {
          subtarefas = data["subtarefas"];
        
          subtarefas.forEach((subtarefa) => {
            criaSubtarefaElement(subtarefa, isNewSubtarefa=false, isInFocus=true)
          })
        
        })
        .catch((error) => {
          console.error("Ocorreu um erro:", error);
          alert(error.message);
        });



      toggleModal("modal-foco-coluna");
      loadingIndicator.style.display = "none";
    }


    // Colocando stopPropagation para evitar a abertura do modal foco coluna
    document.querySelector('.criarSubtarefaBtn').addEventListener('click', (event) => {
      event.stopPropagation();
    })

    function fecharModalFocoColuna(){
      loadingIndicator.style.display = "flex";
      
      const modalFoco = document.getElementById('modal-foco-coluna');
      const modalFocoContainer = modalFoco.querySelector('div.modal-foco-coluna-container')

      const titulo = modalFoco.querySelector('h3#modal-foco-coluna-nome');
      const nome = titulo.textContent;
      var status = modalFocoContainer.getAttribute('nome-status');
      
      const subtarefaLista = document.getElementById(`subtarefas${nome}Lista`);
      subtarefaLista.innerHTML = "";

      fetch(`/ferramentas/tarefa/subtarefas/${status}/${currentTaskId}`, {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                  },
      })
        .then((response) => {
          if (!response.ok) {
            return response.json().then((data) => {;
              throw new Error(data.message);
            });
          }
          return response.json();
        })
        .then((data) => {
          subtarefas = data["subtarefas"];
        
          subtarefas.forEach((subtarefa) => {
            criaSubtarefaElement(subtarefa, isNewSubtarefa=false, isInFocus=false)
          })
        
        })
        .catch((error) => {
          console.error("Ocorreu um erro:", error);
          alert(error.message);
        });
      
      toggleModal("modal-foco-coluna");
      loadingIndicator.style.display = "none";
    }



    function abrirNewTarefaTextModal(){
       if(textareaTarefa != null){
        textareamodal = document.getElementById('textarea-modal-newTarefa-id');
        textareamodal.value = textareaTarefa.value;
        toggleModal('text-modal-newTarefa');
       } else {
          alert('Sem caixa de texto selecionada');
       }
     }
  
     function fecharNewTarefaTextModal(){
        textareamodal = document.getElementById('textarea-modal-newTarefa-id');
        textareaTarefa.value = textareamodal.value
  
        textareaTarefa  = null;
        toggleModal('text-modal-newTarefa');
      }



    document.getElementById("createlead-descricao").addEventListener("click", function (event){
          //alert('taskdesc');event.stopPropagation();
          document.getElementById("titulo-modal").textContent = "Descrição";
           textareaTarefa = document.getElementById("createlead-descricao");
           abrirNewTarefaTextModal();
        })

 function criandoNovoLead() {
  // Obtenha os valores dos campos de entrada
  const horas = document.getElementById('horas-task-new-lead').value;
  const minutes = document.getElementById('minutos-task-new-lead').value;
  
  const dataAtual = new Date();
  const mesesAbreviados = ["jan", "fev", "mar", "abr", "mai", "jun", "jul", "ago", "set", "out", "nov", "dez"];
  const mes = mesesAbreviados[dataAtual.getMonth()]; // Obtenha o nome abreviado do mês
  const ano = dataAtual.getFullYear(); // Obtém o ano atual

  var titulo = document.getElementById('createlead-titulo').value;
  titulo = !titulo ? "Nova Tarefa" : titulo;

  var descricao = document.getElementById('createlead-descricao').value;
  descricao = !descricao ? "" : descricao;

  // Adicione logs para depuração
  console.log("Horas:", horas);
  console.log("Minutos:", minutes);
  console.log("Mês:", mes);
  console.log("Ano:", ano);

  // Verifique se os campos obrigatórios estão preenchidos
  if (horas === '' || minutes === '') {
    alert('Por favor, selecione uma Data Estimada De Término!');
  } else {
    const defaultData = {
      nome: titulo,
      descricao: descricao,
      status: "Status",
      mes: mes, // Já está em formato string abreviado
      ano: ano.toString(), // Converte o ano para string
      horas: horas,
      minutos: minutes
    };

    loadingIndicator.style.display = "flex";
    fetch("/ferramentas/tarefas/adicionar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(defaultData),
    })
    .then((response) => response.json())
    .then((data) => {
      toggleModal('newLead-modal');
      location.reload();
    })
    .catch((error) => {
      loadingIndicator.style.display = "none";
      console.error("Error:", error);
    });
  }
}
function changeYear(direction) {
  loadingIndicator.style.display = "flex";
  window.location.href = `/ferramentas/tarefas/${anoAtualmenteVisivel + direction}`;
}

function changeMonth(direction) {
  loadingIndicator.style.display = "flex";
  let newMes = mesAtualmenteVisivel + direction;
  let newAno = parseInt(anoAtualmenteVisivel);
  if (newMes < 1) {
    newMes = 12;
    newAno -= 1;
  } else if (newMes > 12) {
    newMes = 1;
    newAno += 1;
  }
  window.location.href = `/ferramentas/tarefas/${newAno}/${newMes}`;
}
  
    function allowDrop(ev) {
      ev.preventDefault();
    }
    function selectAllCheckboxSubtarefas(checkbox) {
      document
        .querySelectorAll(".colaboradores-inativos-subtarefas .user-photo")
        .forEach((photo) => {
          if (checkbox.checked) {
            photo.classList.add("selected");
          } else {
            photo.classList.remove("selected");
          }
        });
    }
    function selectAllCheckboxColaboradoresAtivos(checkbox) {
      document
        .querySelectorAll(".colaboradores-inativos .user-photo")
        .forEach((photo) => {
          if (checkbox.checked) {
            photo.classList.add("selected");
          } else {
            photo.classList.remove("selected");
          }
        });
    }
    
    let touchTimer;

    function delayedOnTouchStart(event) {
        touchTimer = setTimeout(() => {
            // Verifica se o toque ainda está pressionado
            if (touchActive) {
                onTouchStart(event);
            }
        }, 1500);
    }

    // Flag para verificar se o toque está ativo
    let touchActive = false;

    // Função chamada quando o toque começa
    function handleTouchStart(event) {
        event.preventDefault();
        touchActive = true;
        delayedOnTouchStart(event);
    }

    // Função chamada quando o toque termina
    function handleTouchEnd(event) {
        touchActive = false;
        clearTimeout(touchTimer);
    }

  
    // Função para lidar com o início do toque
    function onTouchStart(event) {
      // Impede o comportamento padrão para evitar a seleção de texto durante o toque
      event.preventDefault();
  
      subtarefaIdToDragElement = "";
  
      const targetTagName = event.target.tagName.toLowerCase();
      if (targetTagName == "textarea" || targetTagName == "img") return;
  
      // Obtém o ID do toque
      subtarefaIdToDragElement = event.target.closest(".subtarefa");
      const touchID = event.targetTouches[0].identifier;
      // Obtém as coordenadas do toque
      const touchX = event.targetTouches[0].pageX;
      const touchY = event.targetTouches[0].pageY;
      // Define os dados que serão arrastados
      subtarefaIdToDragElement.style.position = "absolute";
      subtarefaIdToDragElement.dataset.touchID = touchID;
      subtarefaIdToDragElement.dataset.touchX = touchX;
      subtarefaIdToDragElement.dataset.touchY = touchY;
      subtarefaIdToDragElement.style.zIndex = 1;
  
      const elementWidth = subtarefaIdToDragElement.getBoundingClientRect().width;
      const elementHeight =
        subtarefaIdToDragElement.getBoundingClientRect().height;
  
  
      subtarefaIdToDragElement.style.left = touchX - elementWidth / 2 + "px";
      subtarefaIdToDragElement.style.top = touchY - elementHeight / 2 + "px";
    }
  
    // Função para lidar com o movimento do toque
    function onTouchMove(event) {
      event.preventDefault();
      if (!subtarefaIdToDragElement) return;
      const touchID = event.targetTouches[0].identifier;
      if (subtarefaIdToDragElement.dataset.touchID == touchID) {
        const offsetX = event.touches[0].clientX;
        const offsetY = event.touches[0].clientY;
        const elementBelow = document.elementFromPoint(offsetX, offsetY);

        // Move o elemento arrastável
        const elementWidth =
          subtarefaIdToDragElement.getBoundingClientRect().width;
        const elementHeight =
          subtarefaIdToDragElement.getBoundingClientRect().height;
        
        subtarefaIdToDragElement.style.left = offsetX - elementWidth / 2 + "px";
        subtarefaIdToDragElement.style.top = offsetY - elementHeight / 2 + "px";
  
        handleHorizontalScroll(offsetX);
      }
    }
    // Função para lidar com o fim do toque
    function onTouchEnd(event) {
      if (!subtarefaIdToDragElement) return;
      // Verifica se o toque está associado ao elemento arrastável
      if (
        subtarefaIdToDragElement.dataset.touchID ==
        event.changedTouches[0].identifier
      ) {
        // Remove os dados de toque do elemento arrastável
        delete subtarefaIdToDragElement.dataset.touchID;
        delete subtarefaIdToDragElement.dataset.touchX;
        delete subtarefaIdToDragElement.dataset.touchY;
        subtarefaIdToDragElement.style.position = "static";
        subtarefaIdToDragElement.style.display = "none";
        // Verifica a posição do toque em relação a outras divs específicas
        const touchX = event.changedTouches[0].clientX;
        const touchY = event.changedTouches[0].clientY;
        const elementBelow = document.elementFromPoint(touchX, touchY);
        subtarefaIdToDragElement.style.display = "flex";

        // Verifica se o toque está sobre a div específica
        if(elementBelow === null){
          const listasDeSubtarefas = document.querySelectorAll(".subtarefasLista");
          for (lista of listasDeSubtarefas) {
            if (lista.contains(elementBelow))
              appendOnSubtarefasLista(subtarefaIdToDragElement.id, lista);
          }
        }
        else if (elementBelow.classList.contains("subtarefasLista")) {
          console.log("Toque sobre a lista de subtarefas específica.");
          appendOnSubtarefasLista(subtarefaIdToDragElement.id, elementBelow);
        }
        else if(elementBelow.closest(".subtarefasLista")){
          const targetArea = elementBelow.closest(".subtarefasLista");
          appendOnSubtarefasLista(subtarefaIdToDragElement.id, targetArea);
        }
      }
      clearInterval(scrollInterval);
      scrollInterval = null;
    }
  
    function drop(ev) {
      ev.preventDefault();
      const targetArea = ev.target.closest(".subtarefasLista");
  
      appendOnSubtarefasLista(subtarefaIdToDrag, targetArea);
    }
    
    function handleHorizontalScroll(offsetX) {
      const scrollContainer = document.querySelector('.subtarefasListasContainer'); 
  
      const containerRect = scrollContainer.getBoundingClientRect();
      const scrollLeft = scrollContainer.scrollLeft;
      const containerWidth = containerRect.width;
      const scrollWidth = scrollContainer.scrollWidth;
  
      const scrollMargin = 70;
  
      if (offsetX > containerRect.right - scrollMargin) {
        startScrolling(scrollContainer, 'right');
      } else if (offsetX < containerRect.left + scrollMargin) {
        startScrolling(scrollContainer, 'left');
      } else {
        clearInterval(scrollInterval);
        scrollInterval = null;
      }

    }
  
    function startScrolling(scrollContainer, direction) {
      const scrollSpeed = 7; // Velocidade do scroll
  
      if (scrollInterval) {
        clearInterval(scrollInterval);
      }
  
      scrollInterval = setInterval(() => {
        if (direction === 'right') {
          scrollContainer.scrollLeft += scrollSpeed;
        } else if (direction === 'left') {
          scrollContainer.scrollLeft -= scrollSpeed;
        }
      }, 10);
    }
  
    function appendOnSubtarefasLista(subtarefaId, targetArea) {
      const draggedElement = document.getElementById(subtarefaId);
  
      const novoStatus = targetArea.getAttribute("nome-status");
  
      const statusAtual = draggedElement.getAttribute("subtarefa-status");

      if (statusAtual == 'lixeira' && !isSuperUser) return;
  
      if (statusAtual == novoStatus) return;
  
      // Move o card para a área de destino
      targetArea.appendChild(draggedElement);
      draggedElement.setAttribute("subtarefa-status", novoStatus);
  
      const tarefaId = document
        .getElementById("subtarefasModal")
        .getAttribute("tarefaId");
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/subtarefas/atualizar_status/${tarefaId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ subtarefa_id: subtarefaId, status: novoStatus }),
      })
        .then((response) => {
          if (!response.ok) {
            loadingIndicator.style.display = "none";
            throw new Error("Erro ao atualizar status.");
          }
          loadingIndicator.style.display = "none";
          if (novoStatus == 'em andamento') {
            currentTaskId = tarefaId;
            currentSubTaskId = subtarefaId;
            toggleModal("estimativaModal")
            updateEstimativaProgressoSubtarefa(tarefaId, subtarefaId);
          }
          if (novoStatus != 'concluido' && novoStatus != 'lixeira'){
            trocaImagemSubtarefa(tarefaId, subtarefaId);
          }
          return response.json();
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao atualizar status:", error);
        });
       
    }
  
    async function criaSubtarefa() {
      try {
        const tarefaId = document
          .getElementById("subtarefasModal")
          .getAttribute("tarefaId");
    
  
        loadingIndicator.style.display = "flex";
        const request = await fetch(
          `/ferramentas/tarefas/subtarefas/adicionar/${tarefaId}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ titulo: "" }),
            //   body: JSON.stringify({ titulo: textoSubtarefa }),
          }
        );
        if (!request.ok) 
          throw new Error("Não conseguiu criar subtarefa");
        
        const response = await request.json();
  
        criaSubtarefaElement(response.subtarefa, true);
        scrollDownTarefasPendentes();
      } catch (error) {
        console.error("Erro ao criar subtarefa: " + error.message);
      } finally {
        loadingIndicator.style.display = "none";
      }
    }
    function abrirOpcoesModal() {
        toggleModal('opcoesModal');
    }
    function abrirEtiquetaModal() {
        toggleModal('etiquetaModal');
    } 
    
    function fecharEtiquetaModal() {
        document.getElementById('etiquetaModal').style.display = 'none';
    }

    window.onclick = function(event) {
        var modal = document.getElementById('etiquetaModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    // Função para criar a etiqueta e salvar no banco de dados
    function criarEtiqueta() {
        const nome = document.getElementById("nomeEtiquetaForm").value;
        const cor = document.getElementById("corEtiquetaForm").value;

        // Validação simples para garantir que nome e cor não estão vazios
        if (!nome || !cor) {
            alert("Por favor, preencha o nome e a cor da etiqueta.");
            return;
        }

        // Dados da nova etiqueta
        const novaEtiqueta = { nome: nome, cor: cor };

        // Enviar a nova etiqueta para o backend
        fetch('/api/etiquetas/criar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ etiquetas: [novaEtiqueta] })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Etiqueta criada e salva com sucesso!');

                // Adicione a nova etiqueta ao formulário de etiquetas
                const etiquetasForm = document.getElementById("etiquetasForm");
                const etiquetaElemento = document.createElement("label");
                etiquetaElemento.innerHTML = `<input type="checkbox" name="etiqueta[]" value="${nome}" color="${cor}"> ${nome}`;
                etiquetasForm.appendChild(etiquetaElemento);

                // Fechar o modal após criar a etiqueta
                toggleModal('etiquetaModal');

                // Limpar os campos do modal de etiquetas
                document.getElementById("nomeEtiquetaForm").value = '';
                document.getElementById("corEtiquetaForm").value = '#000000'; // Definindo para preto como padrão
            } else {
                alert('Erro ao salvar etiqueta: ' + data.message);
            }
        })
        .catch(error => {
            alert('Erro ao salvar etiqueta: ' + error.message);
        });
    }

    
    function abrirColunaSubtarefaModal(botao) {

      const colunaSubtarefaForm = document.getElementById("colunaSubtarefaForm");
      colunaSubtarefaForm.reset()
      if (botao) {

        const subtarefaListaContainer = botao.closest(".subtarefasListaContainer");
        const nome_antigo_coluna = subtarefaListaContainer.querySelector(".subtarefaListaNome").innerText;
        colunaSubtarefaForm.querySelector("[name='nome']").value = nome_antigo_coluna;
        colunaSubtarefaForm.querySelector("[name='nome-antigo-coluna']").value = nome_antigo_coluna;
        
        const cor_antiga_rgb = subtarefaListaContainer.querySelector(".subtarefasLista").style.backgroundColor;

        const [r, g, b] = rgbStringToRgbArray(cor_antiga_rgb);
        const cor_antiga_hex = rgbToHex(r, g, b);
        colunaSubtarefaForm.querySelector("[name='cor']").value = cor_antiga_hex;
      }

      const textoHeader = botao ? "Editar coluna" : "Criar coluna" 
      colunaSubtarefaForm.querySelector(".custom-modal-title").innerText = textoHeader;
      const textoBotaoSubmit = botao ? "Editar" : "Criar" 
      colunaSubtarefaForm.querySelector(".custom-modal-footer .ok-btn").innerText = textoBotaoSubmit;
      
      const tarefaId = document
          .getElementById("subtarefasModal")
          .getAttribute("tarefaId");
    
      colunaSubtarefaForm.querySelector("[name='id-tarefa']").value = tarefaId;

      toggleModal("colunaSubtarefaModal");
    }

    async function removerColunaSubtarefa(botao) {
      try {
        const colunaSubtarefaContainer = botao.closest(".subtarefasListaContainer");
        const nome_coluna = botao.getAttribute('column-name');

        const confirma = confirm(`Tem certeza que deseja remover a coluna "${nome_coluna}"?`)

        if (!confirma) return;

        loadingIndicator.style.display = "flex";

        const id_tarefa = document
        .getElementById("subtarefasModal")
        .getAttribute("tarefaId");

        const response = await fetch("/api/tarefa/coluna/remover",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ id_tarefa, nome_coluna }),
          }
        )

        colunaSubtarefaContainer.remove();

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.error)
        }

      } catch (error) {
        console.error("Erro ao remover coluna:", error);
        alert("Erro ao remover coluna: " + error.message);
      } finally {
        loadingIndicator.style.display = "none";
      }
    }

    function abrirTarefaTextModal(){
       if(textareaTarefa != null){
        textareamodal = document.getElementById('textarea-modal-tarefa-id');
        textareamodal.value = textareaTarefa.value;
        toggleModal('text-modal-tarefa');
       } else {
          alert('Sem caixa de texto selecionada');
       }
     }
  
     function fecharTarefaTextModal(){
        textareamodal = document.getElementById('textarea-modal-tarefa-id');
        textareaTarefa.value = textareamodal.value
  
        textareaTarefa  = null;
        toggleModal('text-modal-tarefa');
      }
      document.getElementById("task-description").addEventListener("click", function (event){
          //alert('taskdesc');event.stopPropagation();
          document.getElementById("titulo-modal").textContent = "Descrição";
           textareaTarefa = document.getElementById("task-description");
           abrirTarefaTextModal();
        })
  
  
     function abrirSubtarefaTextModal(){
       if(textareaSubtarefa != null){
        textareamodal = document.getElementById('textarea-modal-subtarefa-id');
        textareamodal.value = textareaSubtarefa.value;

        // trecho do codigo que redimenciona a textarea
        textareaSubtarefa.style.height = "auto";
        textareaSubtarefa.style.height = textareaSubtarefa.scrollHeight + "px";
        
        toggleModal('text-modal-subtarefa');
        textareamodal.focus();
        if (window.innerWidth <= 768) {
          textareamodal.addEventListener("click", function () {
            this.classList.toggle("zoom");
          });
        }
       } else {
          alert('Sem caixa de texto selecionada');
       }
     }
     
     document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('modal');
      const toolbar = document.getElementById('toolbar');
      const closeBtn = document.querySelector('.close');

      modal.style.display = 'block';

      let isDragging = false;
      let offsetX = 0;

      // Função para mover a toolbar
      const moveToolbar = (event) => {
          if (isDragging) {
              const mouseX = event.clientX - offsetX;
              toolbar.style.transform = `translateX(${mouseX}px)`;
          }
      };

      // Iniciar o movimento da toolbar
      toolbar.addEventListener('mousedown', (event) => {
          isDragging = true;
          offsetX = event.clientX - toolbar.getBoundingClientRect().left;
      });

      // Parar o movimento da toolbar
      document.addEventListener('mouseup', () => {
          isDragging = false;
      });

      // Mover a toolbar conforme o mouse se move
      document.addEventListener('mousemove', moveToolbar);

      // Fechar o modal
      closeBtn.onclick = () => {
          modal.style.display = 'none';
      };

      // Fechar o modal clicando fora dele
      window.onclick = (event) => {
          if (event.target == modal) {
              modal.style.display = 'none';
          }
        };
      });

     function fecharSubtarefaTextModal(){
        textareamodal = document.getElementById('textarea-modal-subtarefa-id');
        textareaSubtarefa.value = textareamodal.value
        //fetchAtualizarTituloSubtarefa();
  
        const tarefaId = document
        .getElementById("subtarefasModal")
        .getAttribute("tarefaId");
      //alert(currentSubTaskId);
        // Executa o fetch com os dados digitados
        loadingIndicator.style.display = "flex";
        fetch(`/ferramentas/tarefas/subtarefas/atualizar_titulo/${tarefaId}`, {
          method: "PUT", // ou 'GET' ou qualquer outro método HTTP necessário
          body: JSON.stringify({
            subtarefa_id: currentSubTaskId,
            titulo: textareamodal.value,
          }),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              loadingIndicator.style.display = "none";
              throw new Error("Erro ao executar o fetch");
            }
            loadingIndicator.style.display = "none";
            return response.json();
          })
          .then((data) => {
            // manipula a resposta recebida, se necessário
            loadingIndicator.style.display = "none";
            console.log("Resposta do servidor:", data);
          })
          .catch((error) => {
            loadingIndicator.style.display = "none";
            console.error("Ocorreu um erro:", error);
          });
          
        // trecho do codigo que redimenciona a textarea
        textareaSubtarefa.style.height = "auto";
        textareaSubtarefa.style.height = textareaSubtarefa.scrollHeight + "px";

        textareaSubtarefa  = null;
        toggleModal('text-modal-subtarefa');
     }
     
     function fetchExcluirEtiqueta(etiqueta, etiquetaElement, tarefaId, subtarefaId) {
        fetch(`/ferramentas/tarefas/subtarefas/etiquetas/remover/${tarefaId}/${subtarefaId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ etiquetas: [etiqueta] }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Etiqueta removida com sucesso.");
                // Remover a etiqueta da interface
                etiquetaElement.remove();
            } else {
                alert("Erro ao remover etiqueta: " + data.message);
            }
        })
        .catch(error => {
            console.error("Erro:", error);
            alert("Ocorreu um erro ao tentar remover a etiqueta.");
        });
    }

    function criaSubtarefaElement(subtarefa, isNewSubtarefa=false, isInFocus=false) {
      // Criar o elemento div
      const subtarefaElement = document.createElement("div");
      subtarefaElement.classList.add("subtarefa");
      subtarefaElement.setAttribute("id", subtarefa.id);
      subtarefaElement.setAttribute("subtarefa-status", subtarefa.status);
      subtarefaElement.setAttribute("draggable", "true");
      subtarefaElement.addEventListener("dragstart", function (ev) {
        subtarefaIdToDrag = subtarefa.id;
      });
      subtarefaElement.addEventListener("touchstart", handleTouchStart);
      subtarefaElement.addEventListener("touchend", handleTouchEnd);
/*       subtarefaElement.addEventListener("touchstart", onTouchStart);
 */      subtarefaElement.addEventListener("touchmove", onTouchMove);
      subtarefaElement.addEventListener("touchend", onTouchEnd);
  
      const tarefaId = document
        .getElementById("subtarefasModal")
        .getAttribute("tarefaId");
      
        function fetchAtualizarTituloSubtarefa() {
        // Obtém o valor digitado no textarea
        const textoDigitado = textarea.value;

        if (textoSubtarefaAntesDeAlterar == textoDigitado) return;

        // Executa o fetch com os dados digitados
        loadingIndicator.style.display = "flex";
        fetch(`/ferramentas/tarefas/subtarefas/atualizar_titulo/${tarefaId}`, {
            method: "PUT", // ou 'GET' ou qualquer outro método HTTP necessário
            body: JSON.stringify({
                subtarefa_id: subtarefa.id,
                titulo: textoDigitado,
            }),
            headers: {
                "Content-Type": "application/json",
            },
        })
        .then((response) => {
            if (!response.ok) {
                loadingIndicator.style.display = "none";
                throw new Error("Erro ao executar o fetch");
            }
            loadingIndicator.style.display = "none";
            return response.json();
        })
        .then((data) => {
            // manipula a resposta recebida, se necessário
            loadingIndicator.style.display = "none";
            console.log("Resposta do servidor:", data);
        })
        .catch((error) => {
            loadingIndicator.style.display = "none";
            console.error("Ocorreu um erro:", error);
        });
      }

      // Criar o elemento para exibir as etiquetas
      const etiquetasContainer = document.createElement("div");
      etiquetasContainer.classList.add("etiquetas-container");
      etiquetasContainer.id = "etiquetas-container-" + subtarefa.id;
      
      subtarefa.etiqueta.forEach(etiqueta => {
          const checkbox = document.querySelector(`input[name="etiquetas[]"][value="${etiqueta.nome}"]`);
          if (checkbox) {
            checkbox.checked = true;
          }
          const etiquetaElement = document.createElement("span");
          etiquetaElement.classList.add("etiqueta");
          etiquetaElement.textContent = etiqueta.nome;
          etiquetaElement.style.backgroundColor = etiqueta.cor;
          etiquetaElement.addEventListener("click", function(event) {
            fetchExcluirEtiqueta(etiqueta, etiquetaElement,  tarefaId, subtarefa.id);
            event.stopPropagation();
         });
          etiquetasContainer.appendChild(etiquetaElement);
      });
      subtarefaElement.appendChild(etiquetasContainer);
  
      function fetchAtualizarTituloSubtarefa() {
        // Obtém o valor digitado no textarea
        const textoDigitado = textarea.value;
  
        if (textoSubtarefaAntesDeAlterar == textoDigitado) return;
  
        // Executa o fetch com os dados digitados
        loadingIndicator.style.display = "flex";
        fetch(`/ferramentas/tarefas/subtarefas/atualizar_titulo/${tarefaId}`, {
          method: "PUT", // ou 'GET' ou qualquer outro método HTTP necessário
          body: JSON.stringify({
            subtarefa_id: subtarefa.id,
            titulo: textoDigitado,
          }),
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((response) => {
            if (!response.ok) {
              loadingIndicator.style.display = "none";
              throw new Error("Erro ao executar o fetch");
            }
            loadingIndicator.style.display = "none";
            return response.json();
          })
          .then((data) => {
            // manipula a resposta recebida, se necessário
            loadingIndicator.style.display = "none";
            console.log("Resposta do servidor:", data);
          })
          .catch((error) => {
            loadingIndicator.style.display = "none";
            console.error("Ocorreu um erro:", error);
          });
      }
  
      // Criar o elemento textarea
      const textarea = document.createElement("textarea");
      textarea.setAttribute("placeholder", "Criar subtarefa...");
      textarea.textContent = subtarefa.titulo;
      textarea.addEventListener("focus", function () {
        textoSubtarefaAntesDeAlterar = textarea.value;
      });

      // Função que vai fazer o redemencionamento da textarea. Ela é chamado no fim da função criaSubtarefaElement
      function autoResizeTextarea(){
        textarea.style.height = 'auto'; // Resetar a altura para calcular a nova altura
        textarea.style.height = textarea.scrollHeight + "px";
      }
  
      //Colocando um listener de click na textarea
      textarea.addEventListener("click", function(evet){
        event.stopPropagation();
        //alert('checkPoint')
        textareaSubtarefa = textarea;
        currentSubTaskId = subtarefa.id;
        abrirSubtarefaTextModal();
      });
  
      textarea.addEventListener("blur", function () {
        fetchAtualizarTituloSubtarefa();
      });
  
      // Adicionando eventos de toque
      textarea.addEventListener("touchstart", function (event) {
        event.stopPropagation(); // Evita que o evento de toque seja propagado para outros elementos
        textoSubtarefaAntesDeAlterar = textarea.value;
      });
  
      textarea.addEventListener("touchend", function (event) {
        event.stopPropagation(); // Evita que o evento de toque seja propagado para outros elementos
        // event.preventDefault();
        fetchAtualizarTituloSubtarefa();
      });
  
  
      // Criar o elemento subtarefaFooter
      const subtarefaFooter = document.createElement("div");
      const subtarefaFooterTop = document.createElement("div");
      const subtarefaFooterBottom = document.createElement("div");
      subtarefaFooterTop.classList.add("subtarefaFooter");
      subtarefaFooterBottom.classList.add("subtarefaFooter");
      // subtarefaFooter.classList.add("subtarefaFooter");
  
      // Adicionando eventos de toque
      textarea.addEventListener("touchstart", function (event) {
        event.stopPropagation(); // Evita que o evento de toque seja propagado para outros elementos
        textoSubtarefaAntesDeAlterar = textarea.value;
      });
  
      function fetchDeleteSubtarefa() {
        toggleModal("delete-item-modal");
  
        document
          .getElementById("confirm-delete-btn")
          .addEventListener("click", function () {
            loadingIndicator.style.display = "flex";
            fetch(`/ferramentas/tarefas/subtarefas/${tarefaId}`, {
              method: "DELETE",
              body: JSON.stringify({
                subtarefa_id: subtarefa.id,
              }),
              headers: {
                "Content-Type": "application/json",
              },
            })
              .then((response) => {
                if (!response.ok) {
                  return response.json().then((data) => {
                    loadingIndicator.style.display = "none";
                    throw new Error(data.message);
                  });
                }
                loadingIndicator.style.display = "none";
                return response.json();
              })
              .then((data) => {
                subtarefaElement.remove();
                loadingIndicator.style.display = "none";
                toggleModal("delete-item-modal");
                alert(data.message);
                console.log("Resposta do servidor:", data);
              })
              .catch((error) => {
                loadingIndicator.style.display = "none";
                console.error("Ocorreu um erro:", error);
                alert(error.message);
              });
          });
      }
      const subTaskFileIcon = document.createElement("div");
      subTaskFileIcon.classList.add("subTaskFile");
      // console.log('arquivos...', subtarefa.arquivos)
      if (subtarefa.arquivos.length > 0) {
        subTaskFileIcon.innerHTML = '<i class="bi bi-file-earmark-check"></i>';
      } else {
        subTaskFileIcon.innerHTML = '<i class="bi bi-file-earmark"></i>';
      }
      subTaskFileIcon.addEventListener("click", function (event) {
        // openUploadSubTaskModal(tarefaId, subtarefa.id);
        event.stopPropagation();
        openSubTaskFilesModal(tarefaId, subtarefa.id);
      });
  
      // Adicionando eventos de toque
      subTaskFileIcon.addEventListener("touchstart", function (event) {
        event.stopPropagation(); // Evita que o evento de toque seja propagado para outros elementos
      });
  
      subTaskFileIcon.addEventListener("touchend", function (event) {
        event.stopPropagation(); // Evita que o evento de toque seja propagado para outros elementos
      });
  
      subtarefaFooterTop.appendChild(subTaskFileIcon);
     
      const subTaskObservationIcon = document.createElement("div");
      subTaskObservationIcon.classList.add("subTaskObservation");
      subTaskObservationIcon.style = 'width: 23px; margin-top: 7px; margin-left: 5px;'
      // console.log('arquivos...', subtarefa.arquivos)
      if(subtarefa.observacoes.length > 0) {
        subTaskObservationIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M15.3 19.1C14.1219 19.6951 12.8199 20.0035 11.5 20C9.92179 19.9994 8.37488 19.5594 7.03258 18.7293C5.69028 17.8992 4.6056 16.7118 3.90003 15.3C3.30496 14.1219 2.99659 12.8199 3.00003 11.5V11C3.11502 8.91568 3.99479 6.94699 5.47089 5.47089C6.94699 3.99479 8.91568 3.11502 11 3.00003M15.3 3.90003C16.7118 4.6056 17.8992 5.69028 18.7293 7.03258C19.5594 8.37488 19.9994 9.92179 20 11.5C20.0035 12.8199 19.6951 14.1219 19.1 15.3L21 21L18 20M8 9.5H15M8 13.5H13" stroke="#36d9ce" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></g></svg>';
      }else{
        subTaskObservationIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M15.3 19.1C14.1219 19.6951 12.8199 20.0035 11.5 20C9.92179 19.9994 8.37488 19.5594 7.03258 18.7293C5.69028 17.8992 4.6056 16.7118 3.90003 15.3C3.30496 14.1219 2.99659 12.8199 3.00003 11.5V11C3.11502 8.91568 3.99479 6.94699 5.47089 5.47089C6.94699 3.99479 8.91568 3.11502 11 3.00003M15.3 3.90003C16.7118 4.6056 17.8992 5.69028 18.7293 7.03258C19.5594 8.37488 19.9994 9.92179 20 11.5C20.0035 12.8199 19.6951 14.1219 19.1 15.3L21 21L18 20M8 9.5H15M8 13.5H13" stroke="#878787" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>';
      }
      subTaskObservationIcon.addEventListener("click", function (event) {
        // openUploadSubTaskModal(tarefaId, subtarefa.id);
        mostrarObservacoesSubTarefaModal(tarefaId, subtarefa.id);
        event.stopPropagation();
        // toggleModal('observacaoModal')
      });
  
      // Adicionando eventos de toque
      subTaskObservationIcon.addEventListener("touchstart", function (event) {
        event.stopPropagation(); // Evita que o evento de toque seja propagado para outros elementos
      });
  
      subTaskObservationIcon.addEventListener("touchend", function (event) {
        event.stopPropagation(); // Evita que o evento de toque seja propagado para outros elementos
      });
  
      subtarefaFooterTop.appendChild(subTaskObservationIcon);
      
      const subtaskEtiquetasIcon = document.createElement("div");
      subtaskEtiquetasIcon.classList.add("subtaskEtiquetasIcon");
      subtaskEtiquetasIcon.style = 'width: 23px; margin-top: 7px; margin-left: 5px;'
      subtaskEtiquetasIcon.innerHTML = '<svg fill="#ffffff" viewBox="0 0 32 32" version="1.1" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <title>tags</title> <path d="M23.531 15.47l-10.501-10.5c-0.136-0.136-0.323-0.22-0.53-0.22-0 0-0 0-0 0h-10.5c-0.414 0-0.75 0.336-0.75 0.75v0 10.5c0 0 0 0 0 0 0 0.207 0.084 0.395 0.22 0.53l10.5 10.501c0.136 0.135 0.323 0.219 0.53 0.219s0.394-0.084 0.53-0.219l10.501-10.501c0.135-0.136 0.218-0.323 0.218-0.53s-0.083-0.394-0.218-0.53l0 0zM12.5 25.439l-9.75-9.75v-9.439h9.439l9.75 9.75zM7.25 8.25c-1.381 0-2.5 1.119-2.5 2.5s1.119 2.5 2.5 2.5c1.381 0 2.5-1.119 2.5-2.5v0c-0.001-1.38-1.12-2.499-2.5-2.5h-0zM7.25 11.75c-0.552 0-1-0.448-1-1s0.448-1 1-1c0.552 0 1 0.448 1 1v0c-0 0.552-0.448 1-1 1h-0zM30.531 15.47l-12-12c-0.136-0.135-0.323-0.218-0.529-0.218-0.414 0-0.75 0.336-0.75 0.75 0 0.206 0.083 0.393 0.218 0.529l11.47 11.47-11.47 11.469c-0.136 0.136-0.22 0.324-0.22 0.531 0 0.415 0.336 0.751 0.751 0.751 0.207 0 0.395-0.084 0.531-0.22v0l12-12.001c0.135-0.136 0.218-0.323 0.218-0.53s-0.083-0.394-0.218-0.53l0 0z"></path> </g></svg>';
      
      subtaskEtiquetasIcon.addEventListener("click", function (event) {
         abrirModalEtiquetas(tarefaId, subtarefa.id)
         event.stopPropagation();
      })

      // Adicionando eventos de toque para subtaskEtiquetasIcon
      subtaskEtiquetasIcon.addEventListener("touchstart", function (event) {
          abrirModalEtiquetas(tarefaId, subtarefa.id);
          event.stopPropagation(); // Evita que o evento de toque seja propagado para outros elementos
      });

      subtaskEtiquetasIcon.addEventListener("touchend", function (event) {
          event.stopPropagation(); // Evita que o evento de toque seja propagado para outros elementos
      });

      
      subtarefaFooterTop.appendChild(subtaskEtiquetasIcon);
      // const trashIcon = document.createElement("img");
      // trashIcon.setAttribute("src", "/static/svg/trashIconWhite.svg");
      // trashIcon.setAttribute("alt", "Avatar");
  
      // trashIcon.classList.add("trashIcon");
      // trashIcon.addEventListener("click", function () {
      //   console.log("Evento click");
      //   fetchDeleteSubtarefa();
      // });
      // trashIcon.addEventListener("touchstart", function (event) {
      //   console.log("Evento touchstart");
      //   event.stopPropagation();
      //   event.preventDefault();
      //   fetchDeleteSubtarefa();
      // });
  
      // subtarefaFooter.appendChild(trashIcon);
  
      // Criar o elemento img
      const creatorImg = document.createElement("img");
      let caminhoImagemUsuario = "user/avatar-1.jpg";
      // if (subtarefa.usuario_criador_imagem) {
      //   caminhoImagemUsuario = subtarefa.usuario_criador_imagem;
      // }
      if (subtarefa.subtarefa_imagem) {
        caminhoImagemUsuario = subtarefa.subtarefa_imagem;
      }
      creatorImg.setAttribute("src", "/static/images/" + caminhoImagemUsuario);
      creatorImg.setAttribute("alt", "");
      creatorImg.classList.add("user-photo");
      creatorImg.addEventListener("click", function () {
        abrirModalColaboradoresSubtarefa(tarefaId, subtarefa.id);
      });
  
      creatorImg.addEventListener("touchstart", function () {
        abrirModalColaboradoresSubtarefa(tarefaId, subtarefa.id);
      });
  
      subtarefaFooterTop.appendChild(creatorImg);
      
      //Criando a imagem do registro
      const subTaskRegisterIcon = document.createElement("img");
      subTaskRegisterIcon.setAttribute("src", "/static/svg/register-svgrepo-com.svg");
      subTaskRegisterIcon.setAttribute("alt", "");
      subTaskRegisterIcon.classList.add("subtask-register-icon");

      subTaskRegisterIcon.addEventListener("click", function (event) {
        abrirModalRegistroSubtarefa(tarefaId, subtarefa.id);
        event.stopPropagation();
      });

      subTaskRegisterIcon.addEventListener("touchstart", function () {
        abrirModalRegistroSubtarefa(tarefaId, subtarefa.id);
      });

      subtarefaFooterTop.appendChild(subTaskRegisterIcon);

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.id = "subtask-" + subtarefa.id;
      checkbox.name = "subtask-checkbox";
      checkbox.classList.add("subtask-checkbox");
      checkbox.addEventListener('change', handleCheckboxChangeSub);

      checkbox.addEventListener('click', (event) => {
        // Impedir a propagação do evento de clique para o elemento pai (subtarefa)
        event.stopPropagation();
      })

      const label = document.createElement("label");
      label.htmlFor = checkbox.id;
      label.classList.add("subtask-checkbox-label");
      label.addEventListener("click", (event) => {
        // Impedir a propagação do evento de clique para o elemento pai (subtarefa)
        event.stopPropagation();
      });
  
      // Adicionando eventos de toque
      label.addEventListener("touchstart", function (event) {
        event.stopPropagation(); // Evita que o evento de toque seja propagado para outros elementos
      });
  
      label.addEventListener("touchend", function (event) {
        event.stopPropagation(); // Evita que o evento de toque seja propagado para outros elementos
      });
  
      subtarefaFooterTop.appendChild(checkbox);
      subtarefaFooterTop.appendChild(label);
  
      subtarefaFooterBottom.innerHTML = `<div class="progress-container">
          <div class="progress-bar progress-green" id="progressBar-${subtarefa.id}">0%</div>
      </div><div class="progress-label" id="progressText-${subtarefa.id}"></div>`
  
      subtarefaFooter.appendChild(subtarefaFooterTop)
      subtarefaFooter.appendChild(subtarefaFooterBottom)
  
      subtarefaElement.appendChild(textarea);
      subtarefaElement.appendChild(subtarefaFooter);
  
      if(subtarefa.status == 'em andamento'){
        updateEstimativaProgressoSubtarefa(tarefaId, subtarefa.id);
      }else{
        try {
          getEstimativaProgressoSubtarefa(tarefaId, subtarefa.id);
        } catch (error) {
          
        }
      }
  
      //const listaParaAdicionar = document.querySelector(`[nome-status="${subtarefa.status}"]`)
      const listaParaAdicionar = isInFocus? document.querySelector(`div.modal-foco-coluna-container[nome-status="${subtarefa.status}"]`):document.querySelector(`[nome-status="${subtarefa.status}"]`)


      if (!listaParaAdicionar) return;

      // Adicionar div ao body (ou a outro elemento desejado)
      listaParaAdicionar.appendChild(subtarefaElement);
      if(isNewSubtarefa){
        textarea.click()
      }
      setTimeout(autoResizeTextarea, 0); // Usando o setTimeOut para garantir que o redimencionamento aconteça depois que a textarea foi renderizada
    }
    function fecharModalSubtarefas() {
      toggleModal("subtarefasModal");
  
      for(let subTaskIdIt of Object.keys(subTaskProgressInterval)){
        clearInterval(subTaskProgressInterval[subTaskIdIt])
        subTaskProgressInterval[subTaskIdIt] = null
      }
  
      const tarefaId = document
        .getElementById("subtarefasModal")
        .getAttribute("tarefaId");
      const linhaTarefa = document.getElementById(tarefaId);
      const icon = linhaTarefa.querySelector(`[data-column-name="subtarefas"] i`);

      const subtarefasListasContainer = document.querySelectorAll("#subtarefasModal .subtarefa");
      
      if (subtarefasListasContainer.length) {
        icon.classList.add("linhaPossuiSubtarefas");
      } else {
        icon.classList.remove("linhaPossuiSubtarefas");
      }

      const listasNaoPadrao = document.querySelectorAll("#subtarefasModal .subtarefasListaContainer[lista_padrao='False']");
      console.log({listasNaoPadrao})
      for (const lista of listasNaoPadrao) {
        lista.remove();
      }

    }
  
    function mostrarRegistros(leadId) {
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/registros/${leadId}`)
        .then((response) => response.json())
        .then((data) => {
          loadingIndicator.style.display = "none";
          const registrosList = document.getElementById("registrosList");
          registrosList.innerHTML = ""; // Limpa os registros existentes
          data.registros.forEach((reg) => {
            const registroDiv = document.createElement("div");
            registroDiv.classList.add("registro");
            registroDiv.classList.add("tooltip");
            const registroTexto = document.createElement("p");
            registroDiv.innerHTML += `<span class="tooltiptext">${reg.alterado_por}</span> `;
            const imageUrl = reg.foto_de_criador
              ? `/static/images/${reg.foto_de_criador}`
              : "/static/svg/avatar.svg";
            registroDiv.innerHTML += `<img class="user-photo" src="${imageUrl}" alt="">`;
            registroTexto.innerHTML += `<span class="registro-valor acao">${reg.acao}:</span> `;
            if (reg.acao != "Criado - Tarefa") {
              registroTexto.innerHTML += `De: <span class="registro-valor registro-valor-anterior">${reg.valor_anterior}</span>, Para: <span class="registro-valor registro-valor-atual">${reg.valor_atual}</span>, `;
            }
            registroTexto.innerHTML += `Por: <span class="registro-valor registro-alterado-por">${reg.alterado_por}</span>, Em: <span class="registro-valor registro-data">${reg.data}</span>`;
  
            registroDiv.appendChild(registroTexto);
            registrosList.appendChild(registroDiv);
          });
          toggleModal("registrosModal"); // Abre a modal
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar registros:", error);
        });
    }
  
    function addButtonClickListener(leadId) {
      adicionarObservacao(leadId);
    }
  
    function mostrarDetalhes(subTarefa) {
      document.getElementById("task-id").value = subTarefa.id;
      document.getElementById("task-criado-em").innerHTML = subTarefa.criado_em;
      document.getElementById("task-criado-por").innerHTML = subTarefa.criado_por;
      document.getElementById("task-descricao").innerHTML = subTarefa.titulo;
    }
  
    function addButtonClickListener(leadId) {
      adicionarObservacao(leadId);
    }
  
    function mostrarObservacoesModal(leadId) {
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/observacoes/${leadId}`)
        .then((response) => response.json())
        .then((data) => {
          loadingIndicator.style.display = "none";
          const observacoesList = document.getElementById("observacoesList");
          observacoesList.innerHTML = ""; // Clear existing observations
          data.observacoes.forEach((obs) => {
            const li = document.createElement("li");
            li.classList.add("observacao");
            li.classList.add("tooltip");

            const regex = /((https?|ftp):\/\/)?(www\.)?[\w.-]+\.[a-z]{2,6}(\/\S*)?/gi;; // Regex para encontrar os links
            // Função para adicionar https:// se necessário
            function addHttps(url) {
                if (!/^https?:\/\//i.test(url)) {
                    return 'https://' + url;
                }
                return url;
            }

            const str = obs.texto.replace(regex, function(match) {
                const url = addHttps(match);
                return `<a href="${url}" target="_blank" class="link-obs">${match}</a>`;
            });

            li.innerHTML = `<span
              class="tooltiptext">${obs.criado_por.nome}</span><img src="${
              obs.criado_por.imagem
                ? "/static/images/" + obs.criado_por.imagem
                : "/static/svg/avatar.svg"           
                }" alt="" class="user-photo"> <p>${str} - ${obs.criado_em}</p>`;
            observacoesList.appendChild(li);
          });
  
          // Prepare to add the observation
          const addButton = document.getElementById("observacaoAdd");
          // Remove any previous click listeners to prevent duplication
          const newClickListener = () => adicionarObservacao(leadId);
          addButton.onclick = newClickListener; // Set the new click listener
  
          toggleModal("observacoesModal"); // Show the modal
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar observações:", error);
        });
    }

function abrirModalEtiquetas(tarefaID, subtarefaId) {
    toggleModal("etiquetasModal");

    // Fetch the etiquetas from the backend
    fetch('/api/etiquetas/consultar')
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.message);
            }

            const etiquetasForm = document.getElementById('etiquetasForm');
            etiquetasForm.innerHTML = ''; // Clear existing etiquetas

            if (Array.isArray(data.etiquetas)) {
                data.etiquetas.forEach(etiqueta => {
                    const etiquetaElement = document.createElement('label');
                    etiquetaElement.innerHTML = `<input type="checkbox" name="etiquetas[]" value="${etiqueta.id}" color="${etiqueta.cor}"> ${etiqueta.nome}`;
                    etiquetasForm.appendChild(etiquetaElement);
                });

                // Fetch the etiquetas already assigned to the subtarefa
                fetch(`/ferramentas/tarefas/subtarefas/etiquetas/buscar/${tarefaID}/${subtarefaId}`, {
                    method: "GET",
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const etiquetasSubtarefa = data.etiquetas;
                        marcarEtiquetas(etiquetasSubtarefa);
                    } else {
                        alert("Erro ao buscar etiquetas da subtarefa: " + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erro ao buscar etiquetas da subtarefa:', error);
                    alert("Ocorreu um erro ao buscar as etiquetas da subtarefa.");
                });
            } else {
                throw new Error("O formato das etiquetas é inválido.");
            }
        })
        .catch(error => {
            console.error('Erro ao buscar etiquetas:', error);
            alert("Ocorreu um erro ao buscar as etiquetas.");
        });

    const adicionarEtiquetasBtn = document.getElementById('adicionarEtiquetasBtn');
    adicionarEtiquetasBtn.addEventListener('click', function () {
        const checkboxes = document.querySelectorAll('input[name="etiquetas[]"]:checked');
        const selectedOptions = Array.from(checkboxes).map(checkbox => {
            return {
                id: checkbox.value, // Use ID para identificar as etiquetas
                cor: checkbox.getAttribute('color')
            };
        });

        console.log(selectedOptions);

        fetch(`/ferramentas/tarefas/subtarefas/etiquetas/adicionar/${tarefaID}/${subtarefaId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ etiquetas: selectedOptions })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Etiquetas adicionadas com sucesso.");
                // Fetch and update the subtarefa etiquetas
                fetch(`/ferramentas/tarefas/subtarefas/etiquetas/buscar/${tarefaID}/${subtarefaId}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json",
                    },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const subtarefa_data = data.etiquetas;
                        const etiquetasContainer = document.getElementById(`etiquetas-container-${subtarefaId}`);
                        etiquetasContainer.innerHTML = ''; // Clear existing etiquetas
                        if (subtarefa_data && Array.isArray(subtarefa_data)) {
                            subtarefa_data.forEach(etiqueta => {
                                const etiquetaElement = document.createElement("span");
                                etiquetaElement.classList.add("etiqueta");
                                etiquetaElement.textContent = etiqueta.nome;
                                etiquetaElement.style.backgroundColor = etiqueta.cor;
                                etiquetaElement.addEventListener("click", function (event) {
                                    fetchExcluirEtiqueta(etiqueta, etiquetaElement, tarefaID, subtarefaId);
                                    event.stopPropagation();
                                });

                                etiquetasContainer.appendChild(etiquetaElement);
                            });
                        } else {
                            console.error("Dados da subtarefa inválidos ou etiquetas não encontradas.");
                            alert("Ocorreu um erro ao atualizar as etiquetas da subtarefa.");
                        }
                    } else {
                        alert("Erro ao buscar etiquetas da subtarefa: " + data.message);
                    }
                })
                .catch(error => {
                    console.error("Ocorreu um erro ao buscar as etiquetas da subtarefa:", error);
                    alert(error.message);
                });

                toggleModal("etiquetasModal");
            } else {
                alert("Erro ao adicionar etiquetas: " + data.message);
            }
        })
        .catch(error => {
            console.error('Erro ao adicionar etiquetas:', error);
            alert("Ocorreu um erro ao tentar adicionar as etiquetas.");
        });
    }, { once: true });
}
function marcarEtiquetas(etiquetasSubtarefa) {
    etiquetasSubtarefa.forEach(etiqueta => {
        const checkbox = document.querySelector(`input[name="etiquetas[]"][value="${etiqueta.id}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
}

    function mostrarObservacoesSubTarefaModal(leadId, subTarefaId) {
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/subtarefas/observacoes/${leadId}/${subTarefaId}`)
        .then((response) => response.json())
        .then((data) => {
          loadingIndicator.style.display = "none";
          const observacoesList = document.getElementById("observacoesList");
          observacoesList.innerHTML = ""; // Clear existing observations
          data.observacoes.forEach((obs) => {
            const li = document.createElement("li");
            li.classList.add("observacao");
            li.classList.add("tooltip");
                        
            const regex = /((https?|ftp):\/\/)?(www\.)?[\w.-]+\.[a-z]{2,6}(\/\S*)?/gi;; // Regex para encontrar os links
            // Função para adicionar https:// se necessário
            function addHttps(url) {
                if (!/^https?:\/\//i.test(url)) {
                    return 'https://' + url;
                }
                return url;
            }

            const str = obs.texto.replace(regex, function(match) {
                const url = addHttps(match);
                return `<a href="${url}" target="_blank" class="link-obs">${match}</a>`;
            });

            li.innerHTML = `<span
              class="tooltiptext">${obs.criado_por.nome}</span><img src="${
              obs.criado_por.imagem
                ? "/static/images/" + obs.criado_por.imagem
                : "/static/svg/avatar.svg"
            }" alt="" class="user-photo"> <p>${str} - ${obs.criado_em}</p>`;
            observacoesList.appendChild(li);
          });
  
          // Prepare to add the observation
          const addButton = document.getElementById("observacaoAdd");
          // Remove any previous click listeners to prevent duplication
          const newClickListener = () => adicionarObservacaoSubTarefa(leadId, subTarefaId);
          addButton.onclick = newClickListener; // Set the new click listener
  
          toggleModal("observacoesModal"); // Show the modal
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar observações:", error);
        });
    }
    function mostrarSubtarefasModal(tarefaId) {
      currentTaskId = tarefaId;
      document
        .getElementById("subtarefasModal")
        .setAttribute("tarefaId", tarefaId);
  
      const listas = document.querySelectorAll(".subtarefasLista");
      for (lista of listas) {
        lista.innerHTML = "";
      }
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/subtarefas/${tarefaId}`)
        .then((response) => response.json())
        .then(async (data) => {
          loadingIndicator.style.display = "none";
          const subtarefasListasContainer = document.querySelector("#subtarefasModal .subtarefasListasContainer");
          for (const coluna of data.colunas) {
            try {
              const { nome, cor } = coluna;
              console.log("coluna:", coluna);
              const request = await fetch("/ferramentas/tarefas/macro/lista-subtarefas",{
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  nome_coluna: nome,
                  nome_status: nome,
                  cor_coluna: cor,
                }),
              });
              if (!request.ok) {
                const errorData = await request.json();
                throw new Error(errorData.error);
              }
              const subtarefaListaContainerHTML  = await request.text();
              adicionarHtmlColunaEmModalSubtarefas(subtarefaListaContainerHTML);
              document.querySelectorAll('.coluna-checkbox').forEach((cb) =>{
                cb.addEventListener('click', (event) =>{
                  event.stopPropagation();
                })
              })
            } catch (error) {
              console.error(`Não foi possível criar a coluna ${coluna}:`, error);
              alert(`Não foi possível criar a coluna ${coluna}: ${error.message}`);
            }
          }
          for (subtarefa of data.subtarefas) {
            if(isAdmin){
              criaSubtarefaElement(subtarefa);
            } else if(subtarefa.status != "lixeira"){
              criaSubtarefaElement(subtarefa);
            }
            // if(subtarefa.status != "lixeira"){
            // criaSubtarefaElement(subtarefa);
            // }
          }
          toggleModal("subtarefasModal"); // Show the modal
        }).catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar subtarefas:", error);
        });
        // atualizarNumItensLixeira(tarefaId);
        scrollDownTarefasPendentes();
    }
    
    function adicionarHtmlColunaEmModalSubtarefas(html) {
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;

      const subtarefaListaContainer = tempDiv.firstElementChild;

      const elementoAntes = document.querySelector("#subtarefasModal [nome-status='concluido']").closest(".subtarefasListaContainer");

      const subtarefasListasContainer = document.querySelector("#subtarefasModal .subtarefasListasContainer");
      subtarefasListasContainer.insertBefore(subtarefaListaContainer, elementoAntes);
    }

    function adicionarObservacao(leadId) {
      const novaObservacao = document.getElementById("novaObservacao").value;
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/observacoes/adicionar/${leadId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          // Inclua outros cabeçalhos necessários aqui
        },
        body: JSON.stringify({ texto: novaObservacao }),
      })
        .then((response) => response.json())
        .then((data) => {
          loadingIndicator.style.display = "none";
          const obs = data.observacao;
          // Adiciona a nova observação à lista na modal
          const observacoesList = document.getElementById("observacoesList");
          const li = document.createElement("li");
          li.classList.add("observacao");
          li.classList.add("tooltip");
          li.innerHTML = `<span
            class="tooltiptext">${obs.criado_por.nome}</span><img src="${
            obs.criado_por.imagem
              ? "/static/images/" + obs.criado_por.imagem
              : "/static/svg/avatar.svg"
          }" alt="" class="user-photo"> <p>${obs.texto} - ${obs.criado_em}</p>`;
          observacoesList.appendChild(li);
          // Limpa o campo de texto para nova observação
          document.getElementById("novaObservacao").value = "";
          mudaCorDeIconeObservacoes(leadId);
        })
        .catch((error) => {
          console.error("Erro ao adicionar nova observação:", error);
          loadingIndicator.style.display = "none";
        });
    }
    function mudaCorDeIconeObservacoes(leadId) {
      console.log(leadId);
  
      const leadElement = document.getElementById(leadId);
      leadElement.querySelector("svg").classList.add("contem-observacao");
    }
  
    function adicionarObservacaoSubTarefa(leadId, subTarefaId) {
      const novaObservacao = document.getElementById("novaObservacao").value;
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/subtarefas/observacoes/adicionar/${leadId}/${subTarefaId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          // Inclua outros cabeçalhos necessários aqui
        },
        body: JSON.stringify({ texto: novaObservacao }),
      })
        .then((response) => response.json())
        .then((data) => {
          loadingIndicator.style.display = "none";
          const obs = data.observacao;
          // Adiciona a nova observação à lista na modal
          const observacoesList = document.getElementById("observacoesList");
          const li = document.createElement("li");
          li.classList.add("observacao");
          li.classList.add("tooltip");
          li.innerHTML = `<span
            class="tooltiptext">${obs.criado_por.nome}</span><img src="${
            obs.criado_por.imagem
              ? "/static/images/" + obs.criado_por.imagem
              : "/static/svg/avatar.svg"
          }" alt="" class="user-photo"> <p>${obs.texto} - ${obs.criado_em}</p>`;
          observacoesList.appendChild(li);
          // Limpa o campo de texto para nova observação
          document.getElementById("novaObservacao").value = "";
          // mudaCorDeIconeObservacoes(`${leadId}-${subTarefaId}`);
          mudaCorDeIconeObservacoes(subTarefaId);
        })
        .catch((error) => {
          console.error("Erro ao adicionar nova observação:", error);
          loadingIndicator.style.display = "none";
        });
    }

    function abrirModalRegistroSubtarefa(tarefa_id, subtarefa_id){

      loadingIndicator.style.display = "flex";

      fetch(`/ferramentas/tarefas/${tarefa_id}/subtarefas/${subtarefa_id}/registros/`)
        .then((response) => response.json())
        .then((data) => {

          loadingIndicator.style.display = "none";

          const registrosList = document.getElementById("registrosList");
          registrosList.innerHTML = ""; // Limpa os registros existentes
          data.registros.forEach((reg) => {
            const registroDiv = document.createElement("div");
            registroDiv.classList.add("registro");
            registroDiv.classList.add("tooltip");
            const registroTexto = document.createElement("p");
            registroDiv.innerHTML += `<span class="tooltiptext">${reg.alterado_por}</span> `;
            const imageUrl = reg.foto_de_criador
              ? `/static/images/${reg.foto_de_criador}`
              : "/static/svg/avatar.svg";
            registroDiv.innerHTML += `<img class="user-photo" src="${imageUrl}" alt="">`;
            registroTexto.innerHTML += `<span class="registro-valor acao">${reg.acao}:</span> `;
            if (reg.acao != "Criado - Tarefa") {
              registroTexto.innerHTML += `De: <span class="registro-valor registro-valor-anterior">${reg.valor_anterior}</span>, Para: <span class="registro-valor registro-valor-atual">${reg.valor_atual}</span>, `;
            }
            registroTexto.innerHTML += `Por: <span class="registro-valor registro-alterado-por">${reg.alterado_por}</span>, Em: <span class="registro-valor registro-data">${reg.data}</span>`;
  
            registroDiv.appendChild(registroTexto);
            registrosList.appendChild(registroDiv);
          });
          toggleModal("registrosModal"); // Abre a modal
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar registros:", error);
        });


      loadingIndicator.style.display = "none";
    }
      
    function abrirModalColaboradoresSubtarefa(tarefaId, subtarefaId) {
      console.log(tarefaId, subtarefaId);
      toggleModal("colaboradores-ativo-subtarefa-modal");
      loadingIndicator.style.display = "flex";
      fetch(
        `/ferramentas/tarefas/${tarefaId}/subtarefas/${subtarefaId}/responsaveis`
      )
        .then((response) => response.json())
        .then((data) => {
          loadingIndicator.style.display = "none";
          const { responsaveis, nao_responsaveis } = data;
          const ativosContainer = document.querySelector(
            ".colaboradores-ativos-subtarefas"
          );
          const inativosContainer = document.querySelector(
            ".colaboradores-inativos-subtarefas"
          );
          console.log({ responsaveis, nao_responsaveis });
          ativosContainer.innerHTML = "";
          inativosContainer.innerHTML = "";
  
          responsaveis.forEach((user) => {
            let photoSrc = `/static/images/${user.imagem}`
              ? `/static/images/${user.imagem}`
              : "/static/svg/avatar.svg";
            ativosContainer.innerHTML += `<div class="user-container">
                  <img src="${photoSrc}" alt="" class="user-photo selected" data-id="${user.id}">
                  <span class="user-name">${user.nome}</span>
              </div>`;
          });
  
          nao_responsaveis.forEach((user) => {
            let photoSrc = `/static/images/${user.imagem}`
              ? `/static/images/${user.imagem}`
              : "/static/svg/avatar.svg";
            inativosContainer.innerHTML += `<div class="user-container">
                  <img src="${photoSrc}" alt="" class="user-photo" data-id="${user.id}">
                  <span class="user-name">${user.nome}</span>
              </div>`;
          });
  
          document.querySelectorAll(".user-photo").forEach((photo) => {
            photo.addEventListener("click", toggleSelectedCollaborator);
          });
  
          document.getElementById(
            "colaboradores-ativo-subtarefa-modal-ok"
          ).onclick = () =>
            atualizarSubTarefasColaboradores(tarefaId, subtarefaId);
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar colaboradores:", error);
        });
    }
  
    function atualizarSubTarefasColaboradores(tarefaId, subtarefa_id) {
      const selecionados = Array.from(
        document.querySelectorAll(
          ".colaboradores-ativos-subtarefas .user-photo.selected"
        )
      ).map((photo) => photo.getAttribute("data-id"));
      const naoSelecionados = Array.from(
        document.querySelectorAll(
          ".colaboradores-inativos-subtarefas .user-photo.selected"
        )
      ).map((photo) => photo.getAttribute("data-id"));
      const dados = {
        responsaveis: selecionados.concat(naoSelecionados), // Combine both selected and deselected users if needed
      };
      loadingIndicator.style.display = "flex";
      fetch(
        `/ferramentas/tarefas/responsaveis/atualizar/${tarefaId}/subtarefas/${subtarefa_id}`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(dados),
        }
      )
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            loadingIndicator.style.display = "none";
            alert(data.message);
            window.location.reload();
            // toggleModal("colaborador-ativo-modal"); // Close the modal after updating
            // Optionally, refresh the part of the page that displays the responsaveis to reflect the updates.
          } else {
            loadingIndicator.style.display = "none";
            throw new Error("Update failed");
          }
        })
        .catch((error) => {
          console.error("Erro ao atualizar colaboradores:", error);
          loadingIndicator.style.display = "none";
        });
    }
  
    function abrirModalColaboradores(tarefaId) {
      toggleModal("colaborador-ativo-modal"); // Assumes you have a function to toggle modal visibility
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/responsaveis/${tarefaId}`)
        .then((response) => response.json())
        .then((data) => {
          loadingIndicator.style.display = "none";
          const { responsaveis, nao_responsaveis } = data;
          const ativosContainer = document.querySelector(".colaboradores-ativos");
          const inativosContainer = document.querySelector(
            ".colaboradores-inativos"
          );
  
          // Clear existing content
          ativosContainer.innerHTML = "";
          inativosContainer.innerHTML = "";
  
          // Populate responsaveis
          responsaveis.forEach((user) => {
            let photoSrc = `/static/images/${user.imagem}`
              ? `/static/images/${user.imagem}`
              : "/static/svg/avatar.svg";
            ativosContainer.innerHTML += `<div class="user-container">
                  <img src="${photoSrc}" alt="" class="user-photo selected" data-id="${user.id}">
                        <span class="user-name">${user.nome}</span>
                    </div>`;
          });
  
          nao_responsaveis.forEach((user) => {
            let photoSrc = `/static/images/${user.imagem}`
              ? `/static/images/${user.imagem}`
              : "/static/svg/avatar.svg";
            inativosContainer.innerHTML += `<div class="user-container">
                        <img src="${photoSrc}" alt="" class="user-photo" data-id="${user.id}">
                        <span class="user-name">${user.nome}</span>
                    </div>`;
          });
  
          // Attach click event for selection toggle
          document.querySelectorAll(".user-photo").forEach((photo) => {
            photo.addEventListener("click", toggleSelectedCollaborator);
          });
  
          // Set update button action
          document.getElementById("btnAtualizarColaboradores").onclick = () =>
            atualizarColaboradores(tarefaId);
        })
        .catch((error) => {
          console.error("Erro ao carregar colaboradores:", error);
          loadingIndicator.style.display = "none";
        });
    }
  
    function atualizarColaboradores(tarefaId) {
      const selecionados = Array.from(
        document.querySelectorAll(".colaboradores-ativos .user-photo.selected")
      ).map((photo) => photo.getAttribute("data-id"));
      const naoSelecionados = Array.from(
        document.querySelectorAll(".colaboradores-inativos .user-photo.selected")
      ).map((photo) => photo.getAttribute("data-id"));
      const dados = {
        responsaveis: selecionados.concat(naoSelecionados), // Combine both selected and deselected users if needed
      };
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/responsaveis/atualizar/${tarefaId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(dados),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            loadingIndicator.style.display = "none";
            alert(data.message);
            toggleModal("colaborador-ativo-modal"); // Close the modal after updating
            // Optionally, refresh the part of the page that displays the responsaveis to reflect the updates.
          } else {
            loadingIndicator.style.display = "none";
            throw new Error("Update failed");
          }
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao atualizar colaboradores:", error);
        });
    }
  
    function carregarDetalhesSubTarefa(subtarefa) {
      console.log(subtarefa);
      mostrarDetalhes(subtarefa);
      toggleModal("detalhes-subtarefa-modal");
    }
  
    function toggleSelectedCollaborator(event) {
      const element = event.currentTarget;
      element.classList.toggle("selected");
    }
    document.querySelectorAll(".user-photo").forEach(function (photo) {
      photo.addEventListener("click", toggleSelectedCollaborator);
    });
  
    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min) + min);
    }
  
    document.getElementById("delete-icon").addEventListener("click", function () {
      if (selectionType == "tarefas") {
        toggleModal("removerLinhaModal");
      } else {
        toggleModal("removerSubLinhaModal");
      }
    });
  
    // document
    //   .getElementById("removerLinhaBtn")
    //   .addEventListener("click", function () {
    //     deleteSelectedLeads();
    //   });
    document
        .getElementById("removerLinhaBtn")
        .addEventListener("click", function () {
          updateSelectedTasks();
          deleteSelectedTasks(); 
        });
      
      var selectedTasks;
      function updateSelectedTasks() {
        selectedTasks = []; // Reset selected tasks array
        document
          .querySelectorAll(".task-checkbox:checked")
          .forEach((checkbox) => {
            const taskId = checkbox.closest("tr").id; // Ensure this ID is a string, not an object
            selectedTasks.push(taskId);
          });
        console.log("Selected Tasks for Action:", selectedTasks);
      }
      // This function doesn't change; it updates the UI based on checkbox states
      function handleCheckboxChange() {
        const anyChecked =
          document.querySelectorAll(".task-checkbox:checked").length > 0;
        const mainToolbar = document.querySelector(".main-toolbar");
        const bottomNav = document.querySelector(".bottom-nav");
        const floatingActionButton = document.querySelector(
          "#floating-action-button-container"
        );
        if (anyChecked) {
          mainToolbar.style.display = "flex"; // Show the toolbar
          bottomNav.style.display = "none";
          floatingActionButton.style.display = "none";
          selectionType = "tarefas";
        } else {
          mainToolbar.style.display = "none"; // Hide the toolbar
          bottomNav.style.display = "flex";
          floatingActionButton.style.display = "flex";
        }
        updateSelectedTasks();
        //updateBarsVisibility();
      }
      function deleteSelectedTasks() {
        if (selectedTasks.length > 0) {
          loadingIndicator.style.display = "flex";
          fetch("/ferramentas/tarefas/deletar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ taskIds: selectedTasks }),
          })
            .then((response) => {
              if (response.ok) {
                loadingIndicator.style.display = "none";
                return response.json();
              } else {
                response.json().then((data) => {
                  loadingIndicator.style.display = "none";
                  alert(data.message);
                  toggleModal("removerLinhaModal");
                });
                return Promise.reject(response.status);
              }
            })
            .then((data) => {
              console.log(data.message);
              document.getElementById("removerLinhaModal").style.display = "none";
              updateSelectedTasks();
              handleCheckboxChange();
              selectedTasks.forEach((taskId) => {
                const taskRow = document.getElementById(taskId);
                if (taskRow) {
                  taskRow.parentNode.removeChild(taskRow);
                }
              });
              selectedTasks = [];
              updateSelectedTasks();
              handleCheckboxChange();
              window.location.reload();
            })
            .catch((error) => {
              loadingIndicator.style.display = "none";
              console.error("Error:", error);
            });
        } else {
          console.log("No tasks selected for deletion.");
        }
      }

      
    
    function sleep(t) {
      return new Promise(resolve => setTimeout(resolve, t));
    }

    async function mostrarSubtarefaSelecionada() {
      const queryParams = new URLSearchParams(window.location.search)
      const tarefa_id = queryParams.get('tarefa_id')
      const subtarefa_id = queryParams.get('subtarefa_id')
      if(tarefa_id && subtarefa_id) {
        mostrarSubtarefasModal(tarefa_id)
      }
      let count = 0;
      while(count < 10) {
        const subtarefa = document.getElementById(subtarefa_id)
        if(subtarefa) {
          subtarefa.scrollIntoView({behavior: 'smooth', block: 'center'})
          await sleep(500)
          subtarefa.style.background = '#e74c3c'
          await sleep(100)
          subtarefa.style.background = ''
          await sleep(100)
          subtarefa.style.background = '#e74c3c'
          await sleep(500)
          subtarefa.style.background = ''
          break
        }
        count += 1
        await sleep(1000)
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      attachCheckboxListeners();
      attachClickEventToTaskNames();
      attachStatusClickEvent();
      attachResponsiblesClickEvent();
      attachEventToEditIcon();
      mostrarSubtarefaSelecionada()
      fetch("/ferramentas/tarefas/statuses")
        .then((response) => response.json())
        .then((tasks) => {
          tasks.forEach((task) => {
            const taskRow = document.getElementById(task.id);
            if (taskRow) {
              const statusCell = taskRow.querySelector(".status-cell");
              if (statusCell) {
                applyStatusColor(statusCell, task.status);
              }
            }
          });
        })
        .catch((error) => console.error("Error loading task statuses:", error));
      function applyStatusColor(cell, status) {
        const className =
          "status " +
          status
            .replace(/\s+/g, "-")
            .toLowerCase()
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "");
        cell.innerHTML = `<div class="${className}" style="color: white;">${status}</div>`;
        // switch (status.toLowerCase()) {
        //   case "concluido":
        //     cell.style.backgroundColor = "#16c079";
        //     break;
        //   case "feito":
        //     cell.style.backgroundColor = "#16c079";
        //     break;
        //   case "em andamento":
        //     cell.style.backgroundColor = "#ff7300";
        //     break;
        //   case "parado":
        //     cell.style.backgroundColor = "#ff4d07";
        //     break;
        //   default:
        //     cell.style.backgroundColor = "";
        // }
      }
  
      document.querySelectorAll(".leadsTable").forEach((table) => {
        table.addEventListener("click", function (event) {
          // Check if the clicked element is a status cell
          if (event.target.classList.contains("status-cell")) {
            // Prevent default action and stop event propagation
            event.preventDefault();
            event.stopPropagation();
  
            // Your existing logic to show status options or handle the click event
            hideAllStatusOptions();
            if (event.target.matches(".col-status")) {
              // Ensure it's the column where status selection should happen
              event.target.appendChild(createStatusOptions(event.target));
            } else if (event.target.closest(".col-status")) {
              // If clicked inside but not directly on the status cell
              event.target
                .closest(".col-status")
                .appendChild(
                  createStatusOptions(event.target.closest(".col-status"))
                );
            }
          }
        });
      });
      const select = document.getElementById('etiquetasSelect');

      select.addEventListener('change', function () {
        selectedEtiquetas = Array.from(select.selectedOptions).map(option => option.value);
      });

      document
        .getElementById("removerLinhaBtn")
        .addEventListener("click", function () {
          // Make sure selectedLeads array is updated before attempting to delete
          updateSelectedTasks();
          deleteSelectedTasks(); // Proceed with deletion
        });
      document
        .getElementById("removerSubLinhaBtn")
        .addEventListener("click", function () {
          // Make sure selectedLeads array is updated before attempting to delete
          updateSelectedSubTasks();
          deleteSelectedSubTasks(); // Proceed with deletion
          toggleModal("removerSubLinhaModal");
        });
  
      function attachCheckboxListeners() {
        document.querySelectorAll(".task-checkbox").forEach(function (checkbox) {
          checkbox.removeEventListener("change", handleCheckboxChange); // Remove existing event listener to avoid duplicates
          checkbox.addEventListener("change", handleCheckboxChange); // Attach new event listener
        });
      }
  
      // // This function doesn't change; it updates the UI based on checkbox states
      // function handleCheckboxChange() {
      //   const anyChecked =
      //     document.querySelectorAll(".task-checkbox:checked").length > 0;
      //   const mainToolbar = document.querySelector(".main-toolbar");
      //   const bottomNav = document.querySelector(".bottom-nav");
      //   const floatingActionButton = document.querySelector(
      //     "#floating-action-button-container"
      //   );
      //   if (anyChecked) {
      //     mainToolbar.style.display = "flex"; // Show the toolbar
      //     bottomNav.style.display = "none";
      //     floatingActionButton.style.display = "none";
      //     selectionType = "tarefas";
      //   } else {
      //     mainToolbar.style.display = "none"; // Hide the toolbar
      //     bottomNav.style.display = "flex";
      //     floatingActionButton.style.display = "flex";
      //   }
      //   updateSelectedTasks();
      //   //updateBarsVisibility();
      // }
  
      attachCheckboxListeners();
      document.querySelectorAll(".createLeadBtn").forEach((button) => {
        console.log({ button });
        button.addEventListener("click", function () {
          console.log("CLICOU");
          const month = this.getAttribute("data-month");
          const day = this.getAttribute("data-day");
          createNewLeadRow(month, day);
        });
      });
      // Fecha a caixa de seleção de status se clicar fora dela
      document.addEventListener("click", function (event) {
        if (!event.target.matches(".status-cell, .status-options div")) {
          hideAllStatusOptions();
        }
      });
      function requestNewLoad(mes, dataTermino, newRow, autoOpen) {
        const defaultData = {
          nome: "Nova Tarefa",
          status: "Status",
          mes: mes,
          ano: anoAtualmenteVisivel.toString(),
          estimativa_conclusao: dataTermino,
        };
  
        console.log({ defaultData });
        loadingIndicator.style.display = "flex";
        fetch("/ferramentas/tarefas/adicionar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(defaultData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success && data.nova_tarefa && data.nova_tarefa._id) {
              loadingIndicator.style.display = "none";
              // Correctly accessing the $oid property
              const taskId = data.nova_tarefa._id.$oid || data.nova_tarefa._id;
              newRow.id = taskId;
              console.log("Tarefa adicionada com sucesso com o ID:", newRow.id);
              attachClickEventListenerToRow(newRow);
              console.log({ newRow, data });
              console.log({ data });
              attachResponsavelImagemToRow(
                newRow,
                data.nova_tarefa.criado_por.imagem
              );
              if(autoOpen) {
                openEditTaskModal(taskId);
              }
            }
          })
          .catch((error) => {
            loadingIndicator.style.display = "none";
            console.error("Error:", error);
          });
      }


      function createNewLeadRow(month, day, autoOpen=false) {
        var table = document
          .getElementById("leadsTable" + day)
          .getElementsByTagName("tbody")[0];
        var newRow = table.insertRow();
        var cellCount = table.rows[0].cells.length;
        const newTaskId = "task-" + Date.now();
  
        let currentDate = new Date();
        if (day === "0") {
          currentDate = "";
        } else {
          currentDate.setFullYear(
            parseInt(anoAtualmenteVisivel),
            mesAtualmenteVisivel - 1,
            day
          );
        }
  
        newRow.id = newTaskId;
        var defaultTexts = {
          selected: "Check",
          "inicio": "agora",
          "nome-tarefa": "Nova Tarefa",
          responsavel: "Resp",
          observacoes: "Observação",
          registros: "Registros",
          subtarefas: "Subtarefas",
          status: "",
          arquivos: "Arquivos",
          "prazo-estimado": "Estimativa não definida",
        };
        const dataTermino = new Date(`2024-02-${getRandomInt(1, 25)}`); // AQUI SÓ PRA TESTAR
        for (var i = 0; i < cellCount; i++) {
          var cell = newRow.insertCell(i);
          cell.setAttribute("contenteditable", "true");
          const columnName = Object.keys(defaultTexts)[i];
          cell.setAttribute("data-column-name", columnName);
          cell.innerHTML = defaultTexts[columnName];
  
          switch (columnName) {
            case "selected":
              {
                cell.innerHTML = "";
                cell.setAttribute("contenteditable", "false");
                var selCheckbox = document.createElement("input");
                selCheckbox.type = "checkbox";
                selCheckbox.id = "taskCheck" + newTaskId;
                selCheckbox.classList.add("task-checkbox");
                selCheckbox.classList.add("custom-checkbox");
                cell.appendChild(selCheckbox);
  
                var label = document.createElement("label");
                label.setAttribute("for", "taskCheck" + newTaskId);
                label.classList.add("task-checkbox-label");
                label.classList.add("custom-checkbox-label");
                cell.appendChild(label);
  
                // Attach event listeners to handle checkbox changes
                selCheckbox.addEventListener("change", function () {
                  updateSelectedTasks();
                  handleCheckboxChange();
                  //updateBarsVisibility();
                });
                attachCheckboxListeners();
              }
              break;
  
            case "inicio":
              {
                cell.setAttribute("contenteditable", "false");
              }
              break;

            case "nome-tarefa":
              {
                cell.setAttribute("contenteditable", "false");
                // cell.classList.add("status-cell");
                cell.addEventListener("click", function (event) {
                  event.stopPropagation();
                  hideAllStatusOptions();
                  toggleModal("edit-task-modal");
                });
              }
              break;
  
            case "status":
              {
                cell.setAttribute("contenteditable", "false");
                  cell.classList.add("status-cell");
                // cell.classList.add("status-cell");
                div = document.createElement("div");
                div.classList.add("status");
                div.classList.add("criado");
                div.innerHTML = "Criado";
                cell.appendChild(div);
                cell.addEventListener("click", function (event) {
                  event.stopPropagation();
                  hideAllStatusOptions();
                  this.appendChild(createStatusOptions(this));
                });
              }
              break;
  
            case "responsavel":
              {
                cell.innerHTML = "";
                const img = document.createElement("img");
                img.src = "/static/images/user/avatar-1.jpg";
                img.alt = "";
                img.classList.add("user-photo");
                cell.appendChild(img);
                cell.setAttribute("contenteditable", "false");
                // cell.classList.add("status-cell");
                // cell.classList.add("svg-image");
                // Adiciona o div de status com a classe 'new-lead' e define a cor do texto para preto
                cell.addEventListener("click", function (event) {
                  event.stopPropagation();
                  hideAllStatusOptions();
                  abrirModalColaboradores(newRow.id);
                });
              }
              break;
  
            case "observacoes":
              {
                // esse primeiro é o ícone de nao ter observação (cinza)
                cell.innerHTML =
                  '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M15.3 19.1C14.1219 19.6951 12.8199 20.0035 11.5 20C9.92179 19.9994 8.37488 19.5594 7.03258 18.7293C5.69028 17.8992 4.6056 16.7118 3.90003 15.3C3.30496 14.1219 2.99659 12.8199 3.00003 11.5V11C3.11502 8.91568 3.99479 6.94699 5.47089 5.47089C6.94699 3.99479 8.91568 3.11502 11 3.00003M15.3 3.90003C16.7118 4.6056 17.8992 5.69028 18.7293 7.03258C19.5594 8.37488 19.9994 9.92179 20 11.5C20.0035 12.8199 19.6951 14.1219 19.1 15.3L21 21L18 20M8 9.5H15M8 13.5H13" stroke="#878787" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>';
                // esse abaixo é o ícone de ter observação (azul)
                //cell.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M15.3 19.1C14.1219 19.6951 12.8199 20.0035 11.5 20C9.92179 19.9994 8.37488 19.5594 7.03258 18.7293C5.69028 17.8992 4.6056 16.7118 3.90003 15.3C3.30496 14.1219 2.99659 12.8199 3.00003 11.5V11C3.11502 8.91568 3.99479 6.94699 5.47089 5.47089C6.94699 3.99479 8.91568 3.11502 11 3.00003M15.3 3.90003C16.7118 4.6056 17.8992 5.69028 18.7293 7.03258C19.5594 8.37488 19.9994 9.92179 20 11.5C20.0035 12.8199 19.6951 14.1219 19.1 15.3L21 21L18 20M8 9.5H15M8 13.5H13" stroke="#36d9ce" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>'
                cell.setAttribute("contenteditable", "false");
                // cell.classList.add("status-cell");
                cell.classList.add("svg-image");
                // Adiciona o div de status com a classe 'new-lead' e define a cor do texto para preto
                cell.addEventListener("click", function (event) {
                  event.stopPropagation();
                  hideAllStatusOptions();
                });
              }
              break;
            case "registros":
              {
                cell.innerHTML = "";
                const img = document.createElement("img");
                img.src = "/static/svg/register-svgrepo-com.svg"; // Caminho relativo à imagem
                img.classList.add("round-img");
                cell.appendChild(img);
                cell.setAttribute("contenteditable", "false");
                // cell.classList.add("status-cell");
                cell.classList.add("svg-image");
                cell.addEventListener("click", function (event) {
                  event.stopPropagation();
                  hideAllStatusOptions();
                  mostrarRegistros(newRow.id);
                });
              }
              break;
            case "subtarefas":
              {
                cell.setAttribute("contenteditable", "false");
                cell.setAttribute("data-column-name", "subtarefas");
                cell.innerHTML = "<i class='bi bi-stack'></i>";
              }
              break;
  
            case "arquivos":
              {
                cell.setAttribute("contenteditable", "false");
                cell.innerHTML = "<i class='bi bi-file-earmark' />";
              }
              break;
  
            default:
              {
                cell.style.color = "Dark Grey"; // Define a cor do texto para preto para outras células
              }
              break;
          }
        }
        console.log("Antes de Enviar", currentDate);
        requestNewLoad(month, currentDate, newRow, autoOpen);
        attachCheckboxListeners();
        attachClickEventListenerToRow(newRow);
        attachSubtarefaEventListenerToRow(newRow);
        attachObservationEventListeners(newRow);
        attachCreateFileEventListeners(newRow);
      }

      function hideAllStatusOptions() {
        var dropdowns = document.getElementsByClassName("status-options");
        Array.from(dropdowns).forEach(function (dropdown) {
          dropdown.remove(); // Remove a lista suspensa do DOM
        });
      }
  
      function createStatusOptions(cell) {
        hideAllStatusOptions();
  
        var statusOptions = document.createElement("div");
        statusOptions.className = "status-options";
        document.body.appendChild(statusOptions); // Anexa a caixa de seleção ao corpo do documento primeiro para obter dimensões
  
        // A caixa de seleção de status é exibida para calcular as dimensões antes do posicionamento
        statusOptions.style.visibility = "hidden";
        statusOptions.style.display = "block";
        statusOptions.style.color = "#fff";
        statusOptions.style.position = "fixed"; // Usando posicionamento fixo
  
        var cellRect = cell.getBoundingClientRect();
  
        // Calcula a posição e ajusta a caixa de seleção de status
        statusOptions.style.left = `${cellRect.left}px`;
        statusOptions.style.top = `${cellRect.top + cellRect.height}px`;
  
        // Agora que as dimensões foram calculadas, a visibilidade é restaurada
        setTimeout(() => {
          statusOptions.style.visibility = "visible";
        }, 0);
  
        var statuses = ["Concluido", "Em andamento", "Parado"];
  
        statuses.forEach(function (status) {
          var option = document.createElement("div");
          option.textContent = status;
          option.className =
            "status-option " + status.replace(/\s+/g, "-").toLowerCase();
          option.addEventListener("click", function (event) {
            updateStatus(cell, status);
            statusOptions.remove();
            event.stopPropagation();
          });
          statusOptions.appendChild(option);
        });
  
        return statusOptions;
      }
      // var selectedTasks;
      // function updateSelectedTasks() {
      //   alert('aqui22')
      //   selectedTasks = []; // Reset selected tasks array
      //   document
      //     .querySelectorAll(".task-checkbox:checked")
      //     .forEach((checkbox) => {
      //       const taskId = checkbox.closest("tr").id; // Ensure this ID is a string, not an object
      //       selectedTasks.push(taskId);
      //     });
      //   console.log("Selected Tasks for Action:", selectedTasks);
      // }
      // function deleteSelectedTasks() {
      //   alert('aqui')
      //   if (selectedTasks.length > 0) {
      //     loadingIndicator.style.display = "flex";
      //     fetch("/ferramentas/tarefas/deletar", {
      //       method: "POST",
      //       headers: {
      //         "Content-Type": "application/json",
      //       },
      //       body: JSON.stringify({ taskIds: selectedTasks }),
      //     })
      //       .then((response) => {
      //         if (response.ok) {
      //           loadingIndicator.style.display = "none";
      //           return response.json();
      //         } else {
      //           response.json().then((data) => {
      //             loadingIndicator.style.display = "none";
      //             alert(data.message);
      //             toggleModal("removerLinhaModal");
      //           });
      //           return Promise.reject(response.status);
      //         }
      //       })
      //       .then((data) => {
      //         console.log(data.message);
      //         document.getElementById("removerLinhaModal").style.display = "none";
      //         updateSelectedTasks();
      //         handleCheckboxChange();
      //         selectedTasks.forEach((taskId) => {
      //           const taskRow = document.getElementById(taskId);
      //           if (taskRow) {
      //             taskRow.parentNode.removeChild(taskRow);
      //           }
      //         });
      //         selectedTasks = [];
      //         updateSelectedTasks();
      //         handleCheckboxChange();
      //       })
      //       .catch((error) => {
      //         loadingIndicator.style.display = "none";
      //         console.error("Error:", error);
      //       });
      //   } else {
      //     console.log("No tasks selected for deletion.");
      //   }
      // }
  
      document
        .getElementById("restaurarLinhaBtn")
        .addEventListener("click", function () {
          restoreSelectedTasks();
        });
  
      function restoreSelectedTasks() {
        if (selectedTasks.length > 0) {
          loadingIndicator.style.display = "flex";
          fetch("/ferramentas/tarefas/restaurar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ taskIds: selectedTasks }),
          })
            .then((response) => {
              if (response.ok) {
                loadingIndicator.style.display = "none";
                return response.json();
              } else {
                response.json().then((data) => {
                  loadingIndicator.style.display = "none";
                  alert(data.message);
                  toggleModal("restaurarLinhaModal");
                });
                return Promise.reject(response.status);
              }
            })
            .then((data) => {
              console.log(data.message);
              document.getElementById("restaurarLinhaModal").style.display =
                "none";
              updateSelectedTasks();
              handleCheckboxChange();
              selectedTasks.forEach((taskId) => {
                const taskRow = document.getElementById(taskId);
                if (taskRow) {
                  taskRow.parentNode.removeChild(taskRow);
                }
              });
              selectedTasks = [];
              updateSelectedTasks();
              handleCheckboxChange();
            })
            .catch((error) => {
              loadingIndicator.style.display = "none";
              console.error("Error:", error);
            });
        } else {
          console.log("No tasks selected for restauration.");
        }
      }
  
      function attachEventToEditIcon() {
        const editIcon = document.getElementById("edit-icon");
        editIcon.addEventListener("click", function () {
          if (selectedTasks.length === 1) {
            const taskId = selectedTasks[0];
            const row = document.getElementById(taskId);
  
            if (!row) {
              console.error("No task row found for ID:", taskId);
              return;
            }
  
            const taskProgressCell = row.querySelector(
              "[data-column-name='nome-tarefa'] .progress-label"
            );
            if(taskProgressCell){
              updateEstimativaProgresso(taskId);
            }else{
              console.log('Não encontrou o progress label')
            }
            // const dueDateText = row.querySelector(
            //   "[data-column-name='prazo-estimado'] .progress-label"
            // ).textContent;
            // const dueDate = convertDateToDateTimeLocal(dueDateText);
            const description =
              row.getAttribute("data-descricao") === "None"
                ? ""
                : row.getAttribute("data-descricao");
            openEditTaskModal(taskId);
          } else {
            toggleModal("edit-warning-modal");
          }
        });
      }
      function updateStatus(cell, status) {
        var statusClass = status.replace(/\s+/g, "-").toLowerCase(); // Creates a class based on the status
        cell.className = "status-cell " + statusClass; // Updates the cell class
  
        // Updates the cell content with the correct structure
        cell.innerHTML = `<div class="status ${statusClass}" style="color: white;">${status}</div>`;
  
        // Save the new status to the database
        const taskId = cell.closest("tr").id; // Assuming the row's id is the task ID
        loadingIndicator.style.display = "flex";
        fetch("/ferramentas/tarefas/atualizar-status/" + taskId, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ status: status }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              loadingIndicator.style.display = "none";
              console.log("Status updated successfully");

              window.location.reload()
            } else {
              loadingIndicator.style.display = "none";
              console.error("Failed to update status");
            }
          })
          .catch((error) => {
            loadingIndicator.style.display = "none";
            console.error("Error updating status:", error);
          });

          fetch("/ferramentas/tarefas/responsaveis/atualizar_imagem/" + taskId, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ tarefa_id: taskId }),
          })
            .then((response) => response.json())
            .then((data) => {
              //alert('entrei')
              if (data.success) {
                //alert('aqui')
                loadingIndicator.style.display = "none";
                console.log("Image updated successfully");
              } else {
                loadingIndicator.style.display = "none";
                console.error("Image failed to update status");
              }
            })
            .catch((error) => {
              loadingIndicator.style.display = "none";
              console.error("Error updating image:", error);
            });



      }
      // Configura as células de status existentes
      document.querySelectorAll(".status-cell").forEach(function (cell) {
        cell.addEventListener("click", function (event) {
          event.stopPropagation(); // Impede que o evento de clique se propague se clicarmos numa célula de status
          hideAllStatusOptions();
          this.appendChild(createStatusOptions(this)); // Passa 'this' como a célula atual
        });
      });
  
      function convertDateToDateTimeLocal(dateStr) {
        const parts = dateStr.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})/);
        if (!parts) return "";
        return `${parts[3]}-${parts[2]}-${parts[1]}T${parts[4]}:${parts[5]}`;
      }
  
      function attachClickEventToTaskNames() {
        // Assuming 'leadsTable' is the class for all your tables
        document.querySelectorAll(".leadsTable tbody tr").forEach((row) => {
          const taskNameCell = row.querySelector(
            "[data-column-name='nome-tarefa']"
          ); // The second cell in each row
          if (taskNameCell) {
            taskNameCell.addEventListener("click", function (event) {
              event.stopPropagation(); // Prevent the event from bubbling up to higher-level elements
              hideAllStatusOptions();
              const taskId = row.id;
              // const dueDateText = row.querySelector(
              //   "[data-column-name='prazo-estimado'] .progress-label, [data-column-name='prazo-estimado'] p"
              // ).textContent;
              // const dueDate = convertDateToDateTimeLocal(dueDateText);
              const description =
                row.getAttribute("data-descricao") === "None"
                  ? ""
                  : row.getAttribute("data-descricao");
              openEditTaskModal(taskId);
            });
          }
  
          const taskProgressCell = row.querySelector('td:nth-child(10) .progress-label')
          if (taskProgressCell) {
            const taskId = row.id;
            updateEstimativaProgresso(taskId);
          }else{
              // console.log('Não encontrou o progress label', row.querySelector('td:nth-child(10)'))
            const progressCell = row.querySelector('td:nth-child(10)')
            if(progressCell){
              progressCell.innerHTML = `<div class="progress-container" data-horas="0" data-minutos="0">
            <div class="progress-bar progress-green" id="progressBar-${row.id}">0%</div>
        </div><div class="progress-label" id="progressText-${row.id}"></div>`
        // updateEstimativaProgresso(row.id);
            }
          }
        });
      }
  
      function attachStatusClickEvent() {
        document.querySelectorAll(".leadsTable tbody tr").forEach((row) => {
          const statusCell = row.querySelector("[data-column-name='status']"); // The fifth cell is the status cell
          if (statusCell) {
            statusCell.addEventListener("click", function (event) {
              event.stopPropagation();
              hideAllStatusOptions();
              this.appendChild(createStatusOptions(this));
            });
          }
        });
      }
      function attachResponsiblesClickEvent() {
        document.querySelectorAll(".leadsTable tbody tr").forEach((row) => {
          const responsibleCell = row.querySelector(
            "[data-column-name='responsavel']"
          ); // The third cell is the responsible cell
          if (responsibleCell) {
            responsibleCell.addEventListener("click", function (event) {
              event.stopPropagation();
              hideAllStatusOptions();
              // toggleModal("colaborador-ativo-modal");
            });
          }
        });
      }
      function attachClickEventListenerToRow(row) {
        const taskNameCell = row.querySelector(
          "[data-column-name='nome-tarefa']"
        ); // Adjust the index as needed
        if (taskNameCell) {
          taskNameCell.addEventListener("click", function (event) {
            event.stopPropagation();
            hideAllStatusOptions();
            const taskId = row.id;
            console.log("Opening edit modal for task ID:", taskId); // Debugging
            openEditTaskModal(taskId); // Adjust arguments as needed
          });
        }
      }
      function attachResponsavelImagemToRow(row, imagemCriador) {
        console.log({ row, imagemCriador });
        const taskNameCell = row.querySelector(
          "[data-column-name='responsavel']"
        );
        if (taskNameCell && imagemCriador) {
          taskNameCell.innerHTML = `<img src="/static/images/${imagemCriador}" alt="" class="user-photo">`;
        }
      }
  
      function attachSubtarefaEventListenerToRow(row) {
        const taskNameCell = row.querySelector("[data-column-name='subtarefas']");
        if (taskNameCell) {
          taskNameCell.addEventListener("click", function (event) {
            event.stopPropagation();
            hideAllStatusOptions();
            mostrarSubtarefasModal(row.id);
          });
        }
      }
  
      function attachObservationEventListeners(row) {
        const observationCell = row.querySelector(
          "[data-column-name='observacoes']"
        );
        if (observationCell) {
          observationCell.addEventListener("click", function (event) {
            hideAllStatusOptions();
            console.log("Opening observation modal for task ID:", row.id); // Debugging
            mostrarObservacoesModal(row.id);
          });
        }
      }
  
      function attachCreateFileEventListeners(row) {
        const fileCell = row.querySelector("[data-column-name='arquivos']");
        if (fileCell) {
          fileCell.addEventListener("click", function (event) {
            event.stopPropagation();
            hideAllStatusOptions();
            const taskId = row.id;
            console.log("Opening file upload modal for task ID:", taskId); // Debugging
            openUploadModal(taskId);
          });
        }
      }
  
      const queryParams = new URLSearchParams(window.location.search);
  
      if (queryParams.has("tarefa")) {
        openEditTaskModal(queryParams.get("tarefa"))
      }
  
  
      /* parte do socket.io */
      var socket = io.connect(
        location.protocol + "//" + document.domain + ":" + location.port
      );
      socket.on("status_updated_tarefa", function (data) {
        console.log("Status update received:", data);
        if (data.tarefa_id) {
          var statusCell = document.querySelector(
            `tr[id="${data.tarefa_id}"] td[data-column-name="status"]`
          );
          var statusClass = data.new_status.replace(/\s+/g, "-").toLowerCase();
          statusCell.className = "status-cell " + statusClass;
          statusCell.innerHTML = `<div class="status ${statusClass}" style="color: white;">${data.new_status}</div>`;
        }
      });
      socket.on("observacao_updated_tarefa", function (data) {
        console.log("Observacao update received:", data);
        if (data.tarefa_id) {
          var observacoesCell = document.querySelector(
            `tr[id="${data.tarefa_id}"] td[data-column-name="observacoes"]`
          );
          if (observacoesCell) {
            mudaCorDeIconeObservacoes(data.tarefa_id);
          }
        }
      });
      socket.on("subtarefas_updated_tarefa", function (data) {
        console.log("Subtarefa update received:", data);
        if (data.tarefa_id) {
          var subtarefasCell = document.querySelector(
            `tr[id="${data.tarefa_id}"] td[data-column-name="subtarefas"]`
          );
          if (subtarefasCell) {
            var icon = document.querySelector(
              `tr[id="${data.tarefa_id}"] td[data-column-name="subtarefas"] i`
            );
            if (icon) {
              icon.classList.add("linhaPossuiSubtarefas");
            }
          }
        }
      });
      socket.on("info_updated_tarefa", function (data) {
        console.log("Info update received:", data);
        if (data.tarefa_id)
          updateTaskDisplayOnPage(
            data.tarefa_id,
            data.title,
            data.description,
            data.hours,
            data.minutes
            // data.due_date
          );
      });
    });
  
    function postEditTask() {
      const taskId = document.getElementById("task-id").value;
      if (!taskId) {
        console.error("Task ID is empty.");
        return;
      }
      const title = document.getElementById("task-title").value;
      const description = document.getElementById("task-description").value;
      const hours = document.getElementById('horas-task-edit').value;
      const minutes = document.getElementById('minutos-task-edit').value;
      // const dueDate = document.getElementById("task-due-date").value;
      console.log("Sending edit task request with data:", {
        taskId,
        title,
        description,
        hours,
        minutes
        // dueDate,
      });
  
      let formData = new FormData();
      formData.append("task_id", taskId);
      formData.append("title", title);
      formData.append("description", description);
      formData.append("hours", hours);
      formData.append("minutes", minutes);
      // formData.append("due_date", dueDate);
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/edit-task/${taskId}`, {
        method: "POST",
        body: formData,
        credentials: "include",
      })
        .then(async (response) => {
          if (!response.ok) {
            loadingIndicator.style.display = "none";
            const responseJson = await response.json()
            if (responseJson.message)
              alert(responseJson.message)
            throw new Error(
              "Network response was not ok: " + response.statusText
            );
          }
          return response.json();
        })
        .then((data) => {
          loadingIndicator.style.display = "none";
          console.log("Success:", data);
          updateTaskDisplayOnPage(taskId, title, description, hours, minutes); // dueDate
          toggleModal("edit-task-modal");
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Error:", error);
        });
    }

    function openEditTaskModal(taskId) {
      console.log("Abrindo modal de edição de tarefa...");
      toggleModal("edit-task-modal");
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/load-tarefa-info-modal/${taskId}`)
        .then((response) => response.json())
        .then((data) => {
          loadingIndicator.style.display = "none";
          document.getElementById("task-id").value = data.id;
          document.getElementById("task-title").value = data.nome;
          document.getElementById("task-description").value = data.descricao;
          document.getElementById("horas-task-edit").value = data.horas;
          document.getElementById("minutos-task-edit").value = data.minutos;
          // document.getElementById("task-due-date").value =
          //   data.estimativa_conclusao;  
          })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar tarefa:", error);
        });
    }
    function updateTaskDisplayOnPage(taskId, title, description, hours, minutes) { // dueDate
      const taskRow = document.getElementById(taskId);
      if (!taskRow) return;
      const titleCell = taskRow.querySelector("[data-column-name='nome-tarefa']");
      if (titleCell) titleCell.textContent = title;
      const progressLabel = taskRow.querySelector(
        "[data-column-name='prazo-estimado'] .progress-label"
      );
      if (progressLabel){
        progressLabel.textContent = `00:00 ${hours}:${minutes}`;
      }else{
        const progressCell = taskRow.querySelector('[data-column-name="prazo-estimado"]')
        if(progressCell){
          progressCell.innerHTML = `<div class="progress-container" data-horas="${hours}" data-minutos="${minutes}">
            <div class="progress-bar progress-green" id="progressBar-${taskRow.id}">0%</div>
        </div><div class="progress-label" id="progressText-${taskRow.id}"></div>`
            }
        }
      // const dueDateCell = taskRow.querySelector(
      //   "[data-column-name='prazo-estimado'] .progress-label"
      // );
      // if (dueDateCell)
      //   dueDateCell.textContent = new Date(dueDate).toLocaleString("pt-BR", {
      //     year: "numeric",
      //     month: "2-digit",
      //     day: "2-digit",  
      //     hour: "2-digit",
      //     minute: "2-digit",
      //   });
    }
    var currentTaskId = null;
    function openUploadModal(taskId) {
      var modal = document.getElementById("create-file-modal");
      if (modal.style.display === "none" || modal.style.display === "") {
        currentTaskId = taskId;
        document.getElementById("task-id-field").value = taskId;
        console.log("Abrindo modal de upload de arquivo...");
        toggleModal("create-file-modal");
        console.log(
          "Modal de upload de arquivo aberta para a tarefa ID:",
          taskId
        );
      }
    }
    var currentSubTaskId = null;
    function openUploadSubTaskModal(taskId, subTaskId) {
      const modal = document.getElementById("create-file-sub-modal");
      if (modal.style.display === "none" || modal.style.display === "") {
        currentTaskId = taskId;
        currentSubTaskId = subTaskId;
        document.getElementById("task-id-field-subtask").value = taskId;
        document.getElementById("subtask-id-field").value = subTaskId;
        console.log("Abrindo modal de upload de arquivo...");
        toggleModal("create-file-sub-modal");
        console.log(
          "Modal de upload de arquivo aberta para a tarefa ID:",
          taskId,
          subTaskId
        );
      }
    }
  
    $(document).ready(function () {
      $("#file-upload-form").on("submit", function (e) {
        e.preventDefault();
        var formData = new FormData(this);
        var submitButton = $(this).find(".ok-btn");
        var cancelButton = $(this).find(".cancel-btn");
        submitButton.prop("disabled", true);
        cancelButton.prop("disabled", true);
        console.log("Enviando formulário de upload de arquivo...");
        $.ajax({
          url: $(this).attr("action"),
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
          beforeSend: function () {
            console.log("Enviando requisição...");
          },
          success: function (data) {
            console.log("Sucesso:", data);
            toggleModal("create-file-modal");
            toggleModal("sucess-upload-modal");
            submitButton.prop("disabled", false); // ativa eles novamente
            cancelButton.prop("disabled", false);
            var row = document.getElementById(currentTaskId.trim());
            if (row) {
              var fileCellIcon = row.querySelector(
                "[data-column-name='arquivos'] i"
              );
              if (fileCellIcon) {
                fileCellIcon.classList.remove("bi-file-earmark");
                fileCellIcon.classList.add("bi-file-earmark-check");
                fileCellIcon.onclick = null;
                fileCellIcon.onclick = function (event) {
                  event.stopPropagation();
                  openTaskFilesModal(currentTaskId);
                };
              }
              var fileCell = row.querySelector("[data-column-name='arquivos']");
              if (fileCell) {
                fileCell.onclick = null;
                fileCell.onclick = function (event) {
                  event.stopPropagation();
                  openTaskFilesModal(currentTaskId);
                };
              }
            }
          },
          error: function (xhr, status, error) {
            console.error("Erro:", error);
            toggleModal("create-file-modal");
            toggleModal("fail-upload-modal");
            submitButton.prop("disabled", false);
            cancelButton.prop("disabled", false);
          },
        });
      });
  
      $("#file-upload-sub-form").on("submit", function (e) {
        e.preventDefault();
        var formData = new FormData(this);
        var submitButton = $(this).find(".ok-btn");
        var cancelButton = $(this).find(".cancel-btn");
        submitButton.prop("disabled", true);
        cancelButton.prop("disabled", true);
        console.log("Enviando formulário de upload de arquivo...");
        $.ajax({
          url: $(this).attr("action"),
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
          beforeSend: function () {
            console.log("Enviando requisição...");
          },
          success: function (data) {
            console.log("Sucesso:", data);
            toggleModal("create-file-sub-modal");
            toggleModal("sucess-upload-modal");
            submitButton.prop("disabled", false); // ativa eles novamente
            cancelButton.prop("disabled", false);
            const fileCellIcon = $(this).find(".subTaskFile");
            if (fileCellIcon) {
              fileCellIcon.html('<i class="bi bi-file-earmark-check"></i>');
            }
          },
          error: function (xhr, status, error) {
            console.error("Erro:", error);
            toggleModal("create-file-sub-modal");
            toggleModal("fail-upload-modal");
            submitButton.prop("disabled", false);
            cancelButton.prop("disabled", false);
          },
        });
      });
  
      $("#colunaSubtarefaForm").on("submit", async function(e) {
        try {
          e.preventDefault();
          loadingIndicator.style.display = "flex";
          
          const formData = new FormData(this);
          
          const editar = formData.get("nome-antigo-coluna");

          const operacao = editar ? "editar" : "adicionar"

          const response = await fetch(`/api/tarefa/coluna/${operacao}`, {
            method: "POST",
            body: formData
          });

          if (!response.ok) {
            const data = await response.json();
            throw new Error(data.error);
          }
          
          if (editar) {
            const nome_antigo = formData.get("nome-antigo-coluna");
            const nome_novo = formData.get("nome");
            const cor_nova = formData.get("cor");
            const subtarefaListaNome = document.querySelector(`.subtarefaListaNome[nome_coluna='${nome_antigo}']`);
            subtarefaListaNome.setAttribute("nome_coluna", nome_novo);
            subtarefaListaNome.innerText = nome_novo;
            
            const subtarefasLista = subtarefaListaNome.closest(".subtarefasListaContainer").querySelector(".subtarefasLista");
            subtarefasLista.setAttribute("nome-status", nome_novo.toLowerCase());
            subtarefasLista.style.backgroundColor = cor_nova;

            const subtarefasNaLista = subtarefasLista.querySelectorAll(".subtarefa")
            subtarefasNaLista.forEach((subtarefa) => 
              subtarefa.setAttribute("subtarefa-status", nome_novo.toLowerCase())
            )
          } else {
            const htmlColuna = await response.text();
            adicionarHtmlColunaEmModalSubtarefas(htmlColuna)
          }
        } catch (error) {
          console.error("Erro ao enviar formulário de coluna:", error);
          alert("Erro ao enviar formulário de coluna: " + error.message);
        } finally {
          loadingIndicator.style.display = "none";
          toggleModal("colunaSubtarefaModal");
        }
      });

      setTimeout(function () {
        updateProgress("criado", tarefasStatus["criado"], tarefasStatus["total"]);
        updateProgress(
          "em-andamento",
          tarefasStatus["em-andamento"],
          tarefasStatus["total"]
        );
        updateProgress("parado", tarefasStatus["parado"], tarefasStatus["total"]);
        updateProgress(
          "concluido",
          tarefasStatus["concluido"],
          tarefasStatus["total"]
        );
      }, 1000);
    });
  
    function openTaskFilesModal(taskId) {
      currentTaskId = taskId;
      console.log("Abrindo modal de arquivos para a tarefa ID:", taskId);
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/arquivos/${taskId}`)
        .then((response) => response.json())
        .then((data) => {
          loadingIndicator.style.display = "none";
          const filesList = document.getElementById("task-files-list");
          filesList.innerHTML = ""; // Limpa a lista antes de adicionar novos itens
          data.arquivos.forEach((arquivo) => {
            const li = document.createElement("li");
            li.textContent = arquivo.nome;
            li.dataset.filePath = arquivo.caminho;
            filesList.appendChild(li);
          });
          toggleModal("task-files-modal");
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar arquivos:", error);
        });
    }
  
    function openSubTaskFilesModal(taskId, subTaskId) {
      currentTaskId = taskId;
      currentSubTaskId = subTaskId;
      console.log(
        "Abrindo modal de arquivos para a tarefa ID:",
        taskId,
        subTaskId
      );
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/subtarefas/arquivos/${taskId}/${subTaskId}`)
        .then((response) => response.json())
        .then((data) => {
          loadingIndicator.style.display = "none";
          const filesList = document.getElementById("subtask-files-list");
          filesList.innerHTML = ""; // Limpa a lista antes de adicionar novos itens
          data.arquivos.forEach((arquivo) => {
            const li = document.createElement("li");
            li.textContent = arquivo.nome;
            li.dataset.filePath = arquivo.caminho;
            filesList.appendChild(li);
          });
          toggleModal("subtask-files-modal");
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar arquivos:", error);
        });
    }
  
    function updateSubTaskEstimation() {
      const taskId = currentTaskId;
      const subTaskId = currentSubTaskId;
      console.log(
        "Abrindo modal de arquivos para a tarefa ID:",
        taskId,
        subTaskId
      );
      loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/subtarefas/atualizar_estimativa_conclusao/${taskId}/${subTaskId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ dias: 0, horas: document.getElementById("horas-subtask").value, minutos: document.getElementById("minutos-subtask").value }),
      })
        .then((response) => response.json())
        .then((data) => {
          loadingIndicator.style.display = "none";
          toggleModal("estimativaModal");
          // getEstimativaProgressoSubtarefa(taskId, subTaskId);
          updateEstimativaProgressoSubtarefa(taskId, subTaskId);
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar arquivos:", error);
        });
    }
  
    function updateEstimativaProgressoSubtarefa(taskId, subTaskId){
      if(subTaskProgressInterval[subTaskId]){
        clearInterval(subTaskProgressInterval[subTaskId])
      }
      try {
        getEstimativaProgressoSubtarefa(taskId, subTaskId)
        subTaskProgressInterval[subTaskId] = setInterval(() => getEstimativaProgressoSubtarefa(taskId, subTaskId), 1000);
      } catch (error) {
        
      }
    }
  
    function updateEstimativaProgresso(taskId){
      if(subTaskProgressInterval[taskId]){
        clearInterval(subTaskProgressInterval[taskId])
      }
      try {
        getEstimativaProgresso(taskId)
        subTaskProgressInterval[taskId] = setInterval(() => getEstimativaProgresso(taskId), 1000);
      } catch (error) {
        
      }
    }
  
    // Evento para adicionar arquivo
    document.getElementById("add-file-btn").addEventListener("click", () => {
      openUploadModal(currentTaskId);
    });
  
    document.getElementById("add-file-sub-btn").addEventListener("click", () => {
      openUploadSubTaskModal(currentTaskId, currentSubTaskId);
    });
  
    // Event listener global para fechar o modal ao clicar fora.
    document.addEventListener("click", function (event) {
      if (
        !event.target.matches(".status-cell, .status-options, .status-options *")
      ) {
        const openedModals = document.querySelectorAll(".status-options");
        openedModals.forEach((modal) => modal.remove());
      }
    });
  
    // Selecionar e remover arquivo
    let selectedFile;
    document
      .getElementById("task-files-list")
      .addEventListener("click", (event) => {
        if (selectedFile) {
          selectedFile.classList.remove("selected");
        }
        selectedFile = event.target;
        selectedFile.classList.add("selected");
        document.getElementById("download-btn").disabled = false;
        document.getElementById("remove-file-btn").disabled = false;
      });
    document
      .getElementById("subtask-files-list")
      .addEventListener("click", (event) => {
        if (selectedFile) {
          selectedFile.classList.remove("selected");
        }
        selectedFile = event.target;
        selectedFile.classList.add("selected");
        document.getElementById("download-sub-btn").disabled = false;
        document.getElementById("remove-file-sub-btn").disabled = false;
      });
  
    document.getElementById("download-btn").addEventListener("click", () => {
      if (selectedFile) {
        const filePath = selectedFile.dataset.filePath.replace(/\\/g, "/");
        const fileName = filePath.split("/").pop();
        console.log(`Caminho completo do arquivo: ${filePath}`);
        console.log(`Nome do arquivo para download: ${fileName}`);
        window.location.href = `/ferramentas/download/tarefa/${encodeURIComponent(
          fileName
        )}`;
      }
    });
    document.getElementById("download-sub-btn").addEventListener("click", () => {
      if (selectedFile) {
        const filePath = selectedFile.dataset.filePath.replace(/\\/g, "/");
        const fileName = filePath.split("/").pop();
        console.log(`Caminho completo do arquivo: ${filePath}`);
        console.log(`Nome do arquivo para download: ${fileName}`);
        window.location.href = `/ferramentas/download/tarefa/${encodeURIComponent(
          fileName
        )}`;
      }
    });
    document.getElementById("remove-file-btn").addEventListener("click", () => {
      if (selectedFile) {
        toggleModal("confirm-remove-file-modal");
      }
    });
    document
      .getElementById("remove-file-sub-btn")
      .addEventListener("click", () => {
        if (selectedFile) {
          toggleModal("confirm-remove-file-sub-modal");
        }
      });
  
    document
      .getElementById("confirm-remove-btn")
      .addEventListener("click", () => {
        if (selectedFile) {
          const filePath = selectedFile.dataset.filePath;
          loadingIndicator.style.display = "flex";
          fetch(`/ferramentas/tarefas/remover/arquivo`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ taskId: currentTaskId, filePath: filePath }),
          })
            .then((response) => response.json())
            .then((data) => {
              loadingIndicator.style.display = "none";
              console.log(data.message);
              selectedFile.remove(); // Remove o arquivo da lista
              document.getElementById("remove-file-btn").disabled = true;
              toggleModal("confirm-remove-file-modal");
              // Verifica se ainda existem arquivos e atualiza o ícone da tarefa
              if (!document.getElementById("task-files-list").hasChildNodes()) {
                var row = document.getElementById(currentTaskId.trim());
                if (row) {
                  var fileCellIcon = row.querySelector(
                    "[data-column-name='nome-tarefa'] i"
                  );
                  if (fileCellIcon) {
                    fileCellIcon.classList.remove("bi-file-earmark-check");
                    fileCellIcon.classList.add("bi-file-earmark");
                    fileCellIcon.onclick = null;
                    fileCellIcon.onclick = function (event) {
                      event.stopPropagation();
                      openUploadModal(currentTaskId);
                    };
                  }
                  var fileCell = row.querySelector(
                    "[data-column-name='arquivos']"
                  );
                  if (fileCell) {
                    fileCell.onclick = null;
                    fileCell.onclick = function (event) {
                      event.stopPropagation();
                      openUploadModal(currentTaskId);
                    };
                  }
                }
              }
            })
            .catch((error) => console.error("Erro ao remover arquivo:", error));
        }
      });
  
    document
      .getElementById("confirm-remove-sub-btn")
      .addEventListener("click", () => {
        if (selectedFile) {
          const filePath = selectedFile.dataset.filePath;
          loadingIndicator.style.display = "flex";
          fetch(`/ferramentas/subtarefas/remover/arquivo`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              taskId: currentTaskId,
              subTaskId: currentSubTaskId,
              filePath: filePath,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              loadingIndicator.style.display = "none";
              console.log(data.message);
              selectedFile.remove(); // Remove o arquivo da lista
              document.getElementById("remove-file-sub-btn").disabled = true;
              toggleModal("confirm-remove-file-sub-modal");
              // Verifica se ainda existem arquivos e atualiza o ícone da tarefa
              // if (!document.getElementById("subtask-files-list").hasChildNodes()) {
              //   var row = document.getElementById(currentTaskId.trim());
              //   if (row) {
              //     var fileCellIcon = row.querySelector(
              //       "[data-column-name='nome-tarefa'] i"
              //     );
              //     if (fileCellIcon) {
              //       fileCellIcon.classList.remove("bi-file-earmark-check");
              //       fileCellIcon.classList.add("bi-file-earmark");
              //       fileCellIcon.onclick = null;
              //       fileCellIcon.onclick = function (event) {
              //         event.stopPropagation();
              //         openUploadModal(currentTaskId);
              //       };
              //     }
              //     var fileCell = row.querySelector(
              //       "[data-column-name='arquivos']"
              //     );
              //     if (fileCell) {
              //       fileCell.onclick = null;
              //       fileCell.onclick = function (event) {
              //         event.stopPropagation();
              //         openUploadModal(currentTaskId);
              //       };
              //     }
              //   }
              // }
            })
            .catch((error) => console.error("Erro ao remover arquivo:", error));
        }
      });
  
    async function atualizarResponsaveis() {
      try {
        const response = await fetch("/api/users");
        const users = await response.json();
        const selectResponsavel = document.getElementById("responsavel");
        selectResponsavel.innerHTML = '<option value="" selected></option>';
  
        users.forEach((user) => {
          const option = document.createElement("option");
          option.value = user.id;
          option.textContent = user.nome;
          selectResponsavel.appendChild(option);
        });
      } catch (error) {
        console.error("Erro ao atualizar responsáveis:", error);
      }
    }
  
    async function atualizarStatus() {
      try {
        const data = ["Em andamento", "Criado", "Parado", "Concluido"];
        const selectStatus = document.getElementById("status");
        selectStatus.innerHTML = '<option value="" selected></option>';
  
        data.forEach((status) => {
          const option = document.createElement("option");
          option.value = status;
          option.textContent = status;
          option.classList.add(`${status.replace(/\s+/g, "-").toLowerCase()}`);
          selectStatus.appendChild(option);
        });
  
        selectStatus.addEventListener("change", () => {
          const selectedOption = selectStatus.value;
          const selectedOptionClasse = selectedOption
            .replace(/\s+/g, "-")
            .toLowerCase();
          const newSelectClass = `${selectedOptionClasse}`;
  
          selectStatus.classList.forEach((className) => {
            selectStatus.classList.remove(className);
          });
  
          selectStatus.classList.add(newSelectClass);
        });
      } catch (error) {
        console.error("Erro ao atualizar status:", error);
      }
    }
  
    async function atualizarCategorias() {
      try {
        const response = await fetch("/ferramentas/planilha-ctt/categorias");
        const data = await response.json();
        const selectCategoria = document.getElementById("categoria");
        selectCategoria.innerHTML = '<option value="" selected></option>';
  
        data.forEach((categoria) => {
          const option = document.createElement("option");
          option.value = categoria;
          option.textContent = categoria;
          selectCategoria.appendChild(option);
        });
      } catch (error) {
        console.error("Erro ao atualizar categorias:", error);
      }
    }
  
    async function atualizarCidades() {
      try {
        const response = await fetch("/ferramentas/planilha-ctt/cidades");
        const data = await response.json();
        const selectCidade = document.getElementById("cidade");
        selectCidade.innerHTML = '<option value="" selected></option>';
  
        data.forEach((cidade) => {
          const option = document.createElement("option");
          option.value = cidade;
          option.textContent = cidade.charAt(0).toUpperCase() + cidade.slice(1);
          selectCidade.appendChild(option);
        });
      } catch (error) {
        console.error("Erro ao atualizar cidades:", error);
      }
    }
  
    async function abrirModalFiltrar() {
      loadingIndicator.style.display = "flex";
  
      await Promise.all([atualizarResponsaveis(), atualizarStatus()]);
  
      const queryString = window.location.search;
  
      const params = new URLSearchParams(queryString);
      const filtroForm = document.getElementById("filtroForm");
  
      for (const [name, value] of params) {
        const select = filtroForm.querySelector(`select[name="${name}"]`);
        if (select) {
          select.value = value;
          if (name == "status") {
            select.classList.add(
              "item-" + value.replace(/\s+/g, "-").toLowerCase()
            );
          }
        }
      }
      filtroForm.querySelector("[name='data_search']").value =
        params.get("data_search");
  
      loadingIndicator.style.display = "none";
  
      toggleModal("filtrarModal");
    }
  
    function updateProgress(containerId, count, total) {
      console.log(containerId, count, total);
      if (total <= 0) {
        return false;
      }
      const progress = Math.round((count / total) * 100);
      const progressCircle = document.querySelector(
        `#status-${containerId} .progress-circle`
      );
      const countElement = document.querySelector(
        `#status-${containerId} .count`
      );
  
      // Atualiza o ângulo do círculo de progresso
      progressCircle.style.background = `radial-gradient(closest-side, white 79%, transparent 80% 100%), conic-gradient(rgba(255, 255, 255, 0.1) ${progress}%, white 0)`;
  
      // Atualiza o texto de contagem
      countElement.textContent = `${count} - ${progress.toFixed(0)}%`;
    }
  
    function handleCheckboxChangeSub() {
      // alert('and')
      const anyChecked =
        document.querySelectorAll(".subtask-checkbox:checked").length > 0;
      const anyCheckedLixeira = isAdmin ?
        document.querySelectorAll("#subtarefasLixeiraLista .subtask-checkbox:checked").length > 0 : false;
      if (isAdmin && anyCheckedLixeira > 0 && document.querySelectorAll(".subtask-checkbox:checked").length != document.querySelectorAll("#subtarefasLixeiraLista .subtask-checkbox:checked").length) {
        alert("Marque apenas um tipo de subtarefas");
        return false
      }
      subtarefaLixeiraVisivel = anyChecked;
      if(!subtarefaLixeiraVisivel){
        lixeiraIcon.style.display = "none";
        deleteIcon.style.display = "block";
      } else {
          lixeiraIcon.style.display = "block";
          deleteIcon.style.display = "none";
      }
      editarColunaIcon.style.display = "none";
      excluirColunaIcon.style.display = "none";
      const mainToolbar = document.querySelector(".main-toolbar");
      const bottomNav = document.querySelector(".bottom-nav");
      const floatingActionButton = document.querySelector(
        "#floating-action-button-container"
      );
      if (anyChecked) {
        mainToolbar.style.display = "flex"; // Show the toolbar
        bottomNav.style.display = "none";
        floatingActionButton.style.display = "none";
        selectionType = "subtarefas";
      } else {
        mainToolbar.style.display = "none"; // Hide the toolbar
        bottomNav.style.display = "flex";
        floatingActionButton.style.display = "flex";
      }
      const toolbar = document.querySelector(".main-toolbar");
      const modal = document.getElementById("subtarefasModal");
      modal.style.height = `calc(100% - ${toolbar.offsetHeight}px)`;
      updateSelectedSubTasks();
      //updateBarsVisibility();
      if(anyCheckedLixeira > 0){
        document.getElementById('excluir-icon').style.display = "block";
        document.getElementById('restaurar-icon').style.display = "block";
        document.getElementById('lixeira-icon').style.display = "none";
        document.getElementById('editar-icon').style.display = "none";
      }else{
        document.getElementById('excluir-icon').style.display = "none";
        document.getElementById('restaurar-icon').style.display = "none";
        document.getElementById('lixeira-icon').style.display = "block";
        document.getElementById('editar-icon').style.display = "block";
      }
    }
  
    var selectedSubTasks;
    function updateSelectedSubTasks() {
      selectedSubTasks = []; // Reset selected tasks array
      document
        .querySelectorAll(".subtask-checkbox:checked")
        .forEach((checkbox) => {
          const taskId = checkbox.closest("div.subtarefa").id; // Ensure this ID is a string, not an object
          selectedSubTasks.push(taskId);
        });
      console.log("Selected SubTasks for Action:", selectedSubTasks);
      
      // Pegando todas as coluna-checkbox
      document
        .querySelectorAll(".coluna-checkbox:checked")
        .forEach((checkbox) => {
          // e desmarcando para evitar problemas
          checkbox.checked = false;
        });
    }
    
    function handleCheckboxChangeColumn() {
      //alert('and')
      const anyChecked =
        document.querySelectorAll(".coluna-checkbox:checked").length > 0;
      
      document.getElementById('excluir-icon').style.display = "none";
      document.getElementById('restaurar-icon').style.display = "none";
      document.getElementById('lixeira-icon').style.display = "none";
      document.getElementById('editar-icon').style.display = "none";
      deleteIcon.style.display = "none";
      editarColunaIcon.style.display = "block";
      excluirColunaIcon.style.display = "block";

      const mainToolbar = document.querySelector(".main-toolbar");
      const bottomNav = document.querySelector(".bottom-nav");
      const floatingActionButton = document.querySelector(
        "#floating-action-button-container"
      );
      if (anyChecked) {
        mainToolbar.style.display = "flex"; // Show the toolbar
        bottomNav.style.display = "none";
        floatingActionButton.style.display = "none";
        selectionType = "colunas";
      } else {
        mainToolbar.style.display = "none"; // Hide the toolbar
        bottomNav.style.display = "flex";
        floatingActionButton.style.display = "flex";
      }
      const toolbar = document.querySelector(".main-toolbar");
      const modal = document.getElementById("subtarefasModal");
      modal.style.height = `calc(100% - ${toolbar.offsetHeight}px)`;
      updateSelectedColumns();
    }
  
    var selectedColumns;
    function updateSelectedColumns() {
      selectedColumns = []; // Reset selected columns array
      document
        .querySelectorAll(".coluna-checkbox:checked")
        .forEach((checkbox) => {
          const columnName = checkbox.getAttribute('column-name');
          selectedColumns.push(columnName);
        });
      console.log("Selected Columns for Action:", selectedColumns);
      
      // Pegando todas subtask-checkbox
      document
        .querySelectorAll(".subtask-checkbox:checked")
        .forEach((checkbox) => {
          // e desmarcando todas elas para evitar problemas
            checkbox.checked = false;
        });
    }

    function deleteSelectedSubTasks() {
      console.log(currentTaskId, selectedSubTasks)
      if (selectedSubTasks.length > 0) {
        loadingIndicator.style.display = "flex";
        fetch("/ferramentas/tarefas/subtarefas/deletar", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            taskId: currentTaskId,
            subTaskIds: selectedSubTasks,
          }),
        })
          .then((response) => {
            if (response.ok) {
              loadingIndicator.style.display = "none";
              // atualizarNumItensLixeira(currentTaskId);
              return response.json();
            } else {
              response.json().then((data) => {
                loadingIndicator.style.display = "none";
                alert(data.message);
                toggleModal("removerLinhaModal");
              });
              return Promise.reject(response.status);
            }
          })
          .then((data) => {
            console.log(data.message);
            document.getElementById("removerLinhaModal").style.display = "none";
            updateSelectedSubTasks();
            handleCheckboxChangeSub();
            selectedSubTasks.forEach((taskId) => {
              const taskRow = document.getElementById(taskId);
              if (taskRow) {
                taskRow.parentNode.removeChild(taskRow);
              }
            });
            selectedSubTasks = [];
            updateSelectedSubTasks();
            handleCheckboxChangeSub();
            // setTimeout(() => {
            //   fecharModalSubtarefas();
            //   mostrarSubtarefasModal(currentTaskId)
            // }, 1000)
          })
          .catch((error) => {
            loadingIndicator.style.display = "none";
            console.error("Error:", error);
          });
          toggleModal('delete-item-modal');
      } else {
        toggleModal('delete-item-modal');
        console.log("No tasks selected for deletion.");
      }
    }
  
    function updateProgressBar(subtarefaId, value, text) {
        const progressBar = document.getElementById(`progressBar-${subtarefaId}`);
        const progressText = document.getElementById(`progressText-${subtarefaId}`);
        const percentage = Math.min(value, 100);
        progressBar.style.width = percentage + '%';
        progressBar.textContent = value.toFixed(2) + '%';
        progressText.textContent = text;
  
        if (value > 100) {
            progressBar.classList.remove('progress-green');
            progressBar.classList.add('progress-red');
            progressBar.style.width = '100%';
        } else {
            progressBar.classList.remove('progress-red');
            progressBar.classList.add('progress-green');
        }
    }
  
    function getEstimativaProgresso(tarefa_id) {
      // console.log("Estimativa", tarefa_id);
      // loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/progresso/${tarefa_id}`)
        .then((response) => response.json())
        .then((data) => {
          // loadingIndicator.style.display = "none";
          // console.log("Progresso", data.progress);
          const progresso = data.progress;
          const texto = `${data.time_elapsed_str} - ${data.time_estimated_str}`;
          if(progresso){
            updateProgressBar(tarefa_id, progresso, texto);
          }else if(subTaskProgressInterval[tarefa_id]){
            clearInterval(subTaskProgressInterval[tarefa_id]);
            subTaskProgressInterval[tarefa_id] = null
          }
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar horários", error);
        });
  
    }
  
    function getEstimativaProgressoSubtarefa(tarefa_id, subtarefa_id) {
      // console.log("Estimativa", tarefa_id);
      // loadingIndicator.style.display = "flex";
      fetch(`/ferramentas/tarefas/subtarefas/progresso/${tarefa_id}/${subtarefa_id}`)
        .then((response) => response.json())
        .then((data) => {
          // loadingIndicator.style.display = "none";
          // console.log("Progresso", data.progress);
          const progresso = data.progress;
          const texto = `${data.time_elapsed_str} - ${data.time_estimated_str}`;
          if(progresso){
            updateProgressBar(subtarefa_id, progresso, texto);
          }else if(subTaskProgressInterval[subtarefa_id]){
            clearInterval(subTaskProgressInterval[subtarefa_id]);
            subTaskProgressInterval[subtarefa_id] = null
          }
        })
        .catch((error) => {
          loadingIndicator.style.display = "none";
          console.error("Erro ao carregar horários", error);
        });
  
    }

  function atualizarNumItensLixeira(tarefaId){
      document
        .getElementById("subtarefasModal")
        .setAttribute("tarefaId", tarefaId);

      const lixeiraBtn = document.getElementById('lixeiraBtn');
      
      var numItensLixeira = 0;

       fetch(`/ferramentas/tarefas/subtarefas/${tarefaId}`)
      .then((response) => response.json())
       .then((data) => {
        loadingIndicator.style.display = "none";
         for (subtarefa of data.subtarefas) {
           if(subtarefa.status == "lixeira"){
             numItensLixeira += 1;
           }
         }
        var str = "Lixeira" + " (" + numItensLixeira + ")";
        
        lixeiraBtn.textContent = str;

      }).catch((error) => {
         loadingIndicator.style.display = "none";
         console.error("Erro ao carregar subtarefas:", error);
      });
  }

  function enviarParaLixeira(){
    novoStatus = "lixeira";
    
    if(selectedSubTasks.length > 0){

      const tarefaId = document
        .getElementById("subtarefasModal")
        .getAttribute("tarefaId");

      
      selectedSubTasks.forEach(SSubTask => {
        //alert(SSubTask);
        
        document
        .querySelectorAll(".subtask-checkbox:checked")
        .forEach((checkbox) => {
          if(checkbox.closest("div.subtarefa").id == SSubTask){
              checkbox.checked = false;
          }
        });
        
       
        fetch(`/ferramentas/tarefas/subtarefas/atualizar_status/${tarefaId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ subtarefa_id: SSubTask, status: novoStatus }),
        })
          .then((response) => {
            if (!response.ok) {
              loadingIndicator.style.display = "none";
              throw new Error("Erro ao atualizar status.");
            }
            loadingIndicator.style.display = "none";
            // atualizarNumItensLixeira(currentTaskId);
            return response.json();
          })
          .catch((error) => {
            loadingIndicator.style.display = "none";
            console.error("Erro ao atualizar status:", error);
          });
          


          document.getElementById(SSubTask).remove();//pegando o modal da subtarefa e apagando ele
      });
      
     handleCheckboxChangeSub();
      

    }else{
      console.log("No tasks selected for deletion.");
    }
    
  }

  lixeiraIcon.addEventListener("click", function(){
    updateSelectedSubTasks();
    enviarParaLixeira();
  });


  

  function criaLixeiraElement(subtarefas){
    //alert(subtarefas);
    var lixeiraModal = document.getElementById('lixeira-custom-modal-content');
    lixeiraModal.innerHTML = ""; // esvaziando a div para evitar criar um em cima do outro
    var listaSubtarefaLixeira = document.createElement("div");
    lixeiraModal.appendChild(listaSubtarefaLixeira);

    for(subtarefa of subtarefas){
          const divSubtarefa = document.createElement("div");
          divSubtarefa.classList.add('lixeira-subtarefa'); 

          const divCheckbox = document.createElement("div");
          divCheckbox.classList.add("custom-checkbox-container");
          const inputCheckbox = document.createElement("input");
          inputCheckbox.type = "checkbox";
          inputCheckbox.classList.add("custom-checkbox");
          inputCheckbox.value = subtarefa.id;
          inputCheckbox.id = `subtarefa-lixeira-${subtarefa.id}`;

          const enviadolabel = document.createElement("label");
          enviadolabel.htmlFor = inputCheckbox.id;
          enviadolabel.classList.add("custom-checkbox-label");

          divCheckbox.appendChild(inputCheckbox);
          divCheckbox.appendChild(enviadolabel);

          const creatorImg = document.createElement("img");

          let caminhoImagemUsuario = "user/avatar-1.jpg";
          if (subtarefa.subtarefa_imagem) {
            caminhoImagemUsuario = subtarefa.subtarefa_imagem;
          }

          creatorImg.setAttribute("src", "/static/images/" + caminhoImagemUsuario);
          creatorImg.setAttribute("alt", "");
          creatorImg.classList.add("user-photo-lixeira");
          divCheckbox.appendChild(creatorImg);

          const textoSubtarefa = document.createElement("h3");
          textoSubtarefa.classList.add("lixeira-titulo-subtarefa");
          textoSubtarefa.innerText = `${subtarefa.titulo}`;
          divCheckbox.appendChild(textoSubtarefa);
          divSubtarefa.appendChild(divCheckbox);

          
          listaSubtarefaLixeira.appendChild(divSubtarefa);

          listaSubtarefaLixeira.appendChild(document.createElement("br"));
    }
    
  }



  function abrirLixeiraModal(){
    loadingIndicator.style.display = "flex";
    var subtarefasNaLixeira = [];

    fetch(`/ferramentas/tarefas/subtarefas/${currentTaskId}`)
      .then((response) => response.json())
      .then((data) => {
        loadingIndicator.style.display = "none";
        for (subtarefa of data.subtarefas) {
          //Verficando se a subtarefa esta na lixeira
          if(subtarefa.status == "lixeira"){
            subtarefasNaLixeira.push(subtarefa);
            //criaLixeiraElement(subtarefa); 
          }
        }
        criaLixeiraElement(subtarefasNaLixeira); 
      })
      .catch((error) => {
        loadingIndicator.style.display = "none";
        console.error("Erro ao carregar subtarefas:", error);
      });
    

    toggleModal('lixeira-modal');
    loadingIndicator.style.display = "none";
  }

  async function restaurarSubtarefaLixeira() {

    const subtarefasSelecionadosLixeira = document.querySelectorAll("#subtarefasLixeiraLista .subtask-checkbox:checked");
    novoStatus = "pendente";

    if (subtarefasSelecionadosLixeira.length == 0) return alert("Nenhuma subtarefa foi selecionado");

    const tarefaId = currentTaskId;
    // const tarefaId = document
    //     .getElementById("subtarefasModal")
    //     .getAttribute("tarefaId");


        var subtarefaIDs = [];

        subtarefasSelecionadosLixeira.forEach(element => {
          subtarefaIDs.push(element.closest(".subtarefa").id);
        });

      
        subtarefaIDs.forEach(SSubTask => {
        //alert(SSubTask);

          fetch(`/ferramentas/tarefas/subtarefas/atualizar_status/${tarefaId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ subtarefa_id: SSubTask, status: novoStatus }),
          })
            .then(async (response) => {
              if (!response.ok) {
                loadingIndicator.style.display = "none";
                const responseJson = await response.json();
                if(responseJson.message){
                  alert(responseJson.message);
                }
                throw new Error("Erro ao atualizar status.");
              }
              document.getElementById(SSubTask).remove()
              // setTimeout(() => {
              //   fecharModalSubtarefas();
              //   mostrarSubtarefasModal(currentTaskId)
              // }, 1000)
              loadingIndicator.style.display = "none";
              // atualizarNumItensLixeira(currentTaskId);
              return response.json();
            })
            .catch((error) => {
              loadingIndicator.style.display = "none";
              console.error("Erro ao atualizar status:", error);
            });
           
            
         })
        //  toggleModal('lixeira-modal');
         //toggleModal('subtarefasModal');
         //window.location.reload();
         //mostrarSubtarefasModal(tarefaId);
        
    
  }

  function abrirDeleteSubtaskModal(){
    
    const subtarefasSelecionadosLixeira = document.querySelectorAll("#subtarefasLixeiraLista .subtask-checkbox:checked");

    const tarefaId = document
        .getElementById("subtarefasModal")
        .getAttribute("tarefaId");

    currentTaskId = tarefaId;

    if (subtarefasSelecionadosLixeira.length == 0) return alert("Nenhuma subtarefa foi selecionado");

        selectedSubTasks = [];
        subtarefasSelecionadosLixeira.forEach(element => {
          selectedSubTasks.push(element.closest(".subtarefa").id);
        });

    //deleteSelectedSubTasks();
    toggleModal('delete-item-modal');
    // toggleModal('lixeira-modal');
  }



  function updateProgressBar(subtarefaId, value, text) {
      const progressBar = document.getElementById(`progressBar-${subtarefaId}`);
      const progressText = document.getElementById(`progressText-${subtarefaId}`);
      const percentage = Math.min(value, 100);
      progressBar.style.width = percentage + '%';
      progressBar.textContent = value.toFixed(2) + '%';
      progressText.textContent = text;

      if (value > 100) {
          progressBar.classList.remove('progress-green');
          progressBar.classList.add('progress-red');
          progressBar.style.width = '100%';
      } else {
          progressBar.classList.remove('progress-red');
          progressBar.classList.add('progress-green');
      }
  }

  function getEstimativaProgresso(tarefa_id) {
    // console.log("Estimativa", tarefa_id);
    // loadingIndicator.style.display = "flex";
    fetch(`/ferramentas/tarefas/progresso/${tarefa_id}`)
      .then((response) => response.json())
      .then((data) => {
        // loadingIndicator.style.display = "none";
        // console.log("Progresso", data.progress);
        const progresso = data.progress;
        const texto = `${data.time_elapsed_str} - ${data.time_estimated_str}`;
        if(progresso){
          updateProgressBar(tarefa_id, progresso, texto);
        }else if(subTaskProgressInterval[tarefa_id]){
          clearInterval(subTaskProgressInterval[tarefa_id]);
          subTaskProgressInterval[tarefa_id] = null
        }
      })
      .catch((error) => {
        loadingIndicator.style.display = "none";
        console.error("Erro ao carregar horários", error);
      });

  }

  function getEstimativaProgressoSubtarefa(tarefa_id, subtarefa_id) {
    // console.log("Estimativa", tarefa_id);
    // loadingIndicator.style.display = "flex";
    fetch(`/ferramentas/tarefas/subtarefas/progresso/${tarefa_id}/${subtarefa_id}`)
      .then((response) => response.json())
      .then((data) => {
        // loadingIndicator.style.display = "none";
        // console.log("Progresso", data.progress);
        const progresso = data.progress;
        const texto = `${data.time_elapsed_str} - ${data.time_estimated_str}`;
        if(progresso){
          updateProgressBar(subtarefa_id, progresso, texto);
        }else if(subTaskProgressInterval[subtarefa_id]){
          clearInterval(subTaskProgressInterval[subtarefa_id]);
          subTaskProgressInterval[subtarefa_id] = null
        }
      })
      .catch((error) => {
        loadingIndicator.style.display = "none";
        console.error("Erro ao carregar horários", error);
      });

  }

  function trocaImagemSubtarefa(tarefaId, subtarefaId, novaImagem){

    //alert('AQUIii' + tarefaId + subtarefaId + novaImagem)
    const subtarefaModal = document.getElementById(subtarefaId);
    const img = subtarefaModal.querySelector('img'); 


    fetch(`/ferramentas/tarefas/subtarefas/atualizar_imagem/${tarefaId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ subtarefa_id: subtarefaId, nova_imagem: novaImagem }),
          })
            .then((response) => response.json() )
            .then((data) => {
              //alert("data.novaImagem")
               img.src = "/static/images/" + data.novaImagem;
               loadingIndicator.style.display = "none";
            })
            .catch((error) => {
              loadingIndicator.style.display = "none";
              console.error("Erro ao atualizar imagem:", error);
            });


           

           

  }


</script>
{% endblock %}
